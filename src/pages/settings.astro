---
import { clerkClient } from '@clerk/astro/server';
import { db, Users, eq } from 'astro:db';
import Layout from '../layouts/Layout.astro';

const { userId } = Astro.locals.auth();
if (!userId) {
  return Astro.redirect('/sign-in');
}

const clerkUser = await clerkClient(Astro).users.getUser(userId);

let currentUser = await db
  .select()
  .from(Users)
  .where(eq(Users.clerkUserId, userId))
  .get();

if (!currentUser) {
  try {
    await db.insert(Users).values({
      clerkUserId: userId,
      email: clerkUser.emailAddresses[0]?.emailAddress || '',
      name:
        `${clerkUser.firstName || ''} ${clerkUser.lastName || ''}`.trim() ||
        clerkUser.emailAddresses[0]?.emailAddress ||
        'User',
      createdAt: new Date(),
    });
  } catch (error) {
    if (!(error instanceof Error && error.message.includes('UNIQUE constraint'))) {
      throw error;
    }
  }

  currentUser = await db
    .select()
    .from(Users)
    .where(eq(Users.clerkUserId, userId))
    .get();
}

const notificationsEnabled = currentUser?.browserNotificationsEnabled ?? false;
---

<Layout title="Settings - Torsdagskos">
  <section class="settings-container" aria-labelledby="settings-title">
    <a href="/" class="back-link">&larr; Back to Events</a>
    <h1 id="settings-title" class="page-title">Settings</h1>

    <article class="settings-card" aria-labelledby="notifications-title">
      <h2 id="notifications-title">Browser Notifications</h2>
      <p class="description">
        Enable browser notifications to receive alerts directly in this browser.
      </p>

      <dl class="status-grid">
        <div>
          <dt>Permission status</dt>
          <dd id="permission-status">Checking...</dd>
        </div>
        <div>
          <dt>Saved preference</dt>
          <dd id="saved-preference" data-enabled={String(notificationsEnabled)}>
            {notificationsEnabled ? 'Enabled' : 'Disabled'}
          </dd>
        </div>
      </dl>

      <button type="button" id="request-permission" class="request-button">
        Request notification permission
      </button>

      <p id="feedback" class="feedback" role="status" aria-live="polite"></p>
    </article>
  </section>
</Layout>

<script>
  // @ts-nocheck
  const permissionStatus = document.getElementById('permission-status');
  const savedPreference = document.getElementById('saved-preference');
  const requestButton = document.getElementById('request-permission');
  const feedback = document.getElementById('feedback');

  /** @type {(permission: string) => string} */
  const capitalize = (permission) => {
    if (!permission) return 'Unknown';
    return permission.charAt(0).toUpperCase() + permission.slice(1);
  }

  /** @type {(message: string, type: 'success' | 'error') => void} */
  const setFeedback = (message, type) => {
    if (!feedback) return;
    feedback.textContent = message;
    feedback.classList.remove('feedback-success', 'feedback-error');

    if (type === 'success') {
      feedback.classList.add('feedback-success');
    }

    if (type === 'error') {
      feedback.classList.add('feedback-error');
    }
  }

  function setPermissionDisplay() {
    if (!permissionStatus || !requestButton) {
      return;
    }

    if (!('Notification' in window)) {
      permissionStatus.textContent = 'Unsupported';
      requestButton.setAttribute('disabled', 'true');
      setFeedback('This browser does not support notifications.', 'error');
      return;
    }

    permissionStatus.textContent = capitalize(Notification.permission);
  }

  /** @type {(enabled: boolean) => Promise<unknown>} */
  const savePreference = async (enabled) => {
    const response = await fetch('/api/settings/notifications', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({ enabled }),
    });

    if (!response.ok) {
      throw new Error('Unable to save notification preference');
    }

    return response.json();
  }

  setPermissionDisplay();

  requestButton?.addEventListener('click', async () => {
    if (!('Notification' in window)) {
      setFeedback('Notifications are not supported in this browser.', 'error');
      return;
    }

    requestButton.setAttribute('disabled', 'true');

    try {
      const permission = await Notification.requestPermission();
      setPermissionDisplay();

      const enabled = permission === 'granted';
      await savePreference(enabled);

      if (savedPreference) {
        savedPreference.textContent = enabled ? 'Enabled' : 'Disabled';
        savedPreference.setAttribute('data-enabled', String(enabled));
      }

      if (enabled) {
        setFeedback('Browser notifications enabled.', 'success');
      } else {
        setFeedback('Browser notifications are disabled for this browser.', 'success');
      }
    } catch (error) {
      console.error('Notification preference update failed:', error);
      setFeedback('Could not update notification settings. Please try again.', 'error');
    } finally {
      requestButton.removeAttribute('disabled');
    }
  });
</script>

<style>
  .settings-container {
    max-width: 760px;
    margin: 0 auto;
    display: grid;
    gap: var(--space-6);
  }

  .back-link {
    color: var(--color-accent);
    text-decoration: none;
    width: fit-content;
  }

  .back-link:hover {
    color: var(--color-accent-dark);
  }

  .page-title {
    margin: 0;
    font-size: 2rem;
  }

  .settings-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-6);
    box-shadow: var(--shadow-sm);
  }

  .settings-card h2 {
    margin-top: 0;
    margin-bottom: var(--space-2);
    font-size: 1.4rem;
  }

  .description {
    margin-top: 0;
    margin-bottom: var(--space-5);
    color: var(--color-text-secondary);
  }

  .status-grid {
    display: grid;
    gap: var(--space-4);
    margin: 0 0 var(--space-5) 0;
  }

  .status-grid div {
    background: var(--color-primary-100);
    border-radius: var(--radius-md);
    padding: var(--space-4);
    border: 1px solid var(--color-border);
  }

  .status-grid dt {
    color: var(--color-text-secondary);
    font-size: 0.9rem;
    margin-bottom: var(--space-1);
  }

  .status-grid dd {
    margin: 0;
    font-size: 1.05rem;
    font-weight: 600;
    color: var(--color-accent-dark);
  }

  .request-button {
    border: none;
    border-radius: var(--radius-md);
    padding: var(--space-3) var(--space-5);
    background: var(--color-accent);
    color: white;
    font-size: 1rem;
    cursor: pointer;
    transition: background-color 0.2s ease;
    min-height: 44px;
  }

  .request-button:hover:not(:disabled) {
    background: var(--color-accent-dark);
  }

  .request-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .request-button:focus {
    outline: 2px solid var(--color-accent);
    outline-offset: 2px;
  }

  .feedback {
    min-height: 1.5rem;
    margin-top: var(--space-4);
    margin-bottom: 0;
    color: var(--color-text-secondary);
  }

  .feedback-success {
    color: var(--color-success);
  }

  .feedback-error {
    color: var(--color-error);
  }

  @media (min-width: 640px) {
    .status-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }
</style>
