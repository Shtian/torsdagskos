---
import Layout from '../layouts/Layout.astro';
import { clerkClient } from '@clerk/astro/server';
import { db, Users, Events, Rsvps, eq } from 'astro:db';

const { userId } = Astro.locals.auth();

let currentUser = await db
  .select()
  .from(Users)
  .where(eq(Users.clerkUserId, userId!))
  .get();

// Keep this page resilient when users navigate here before homepage sync runs.
if (!currentUser && userId) {
  const clerkUser = await clerkClient(Astro).users.getUser(userId);

  try {
    await db.insert(Users).values({
      clerkUserId: userId,
      email: clerkUser.emailAddresses[0]?.emailAddress || '',
      name: `${clerkUser.firstName || ''} ${clerkUser.lastName || ''}`.trim() || clerkUser.emailAddresses[0]?.emailAddress || 'User',
      createdAt: new Date(),
    });
  } catch (error) {
    if (!(error instanceof Error && error.message.includes('UNIQUE constraint'))) {
      throw error;
    }
  }

  currentUser = await db
    .select()
    .from(Users)
    .where(eq(Users.clerkUserId, userId))
    .get();
}

const historyItems = currentUser
  ? await Promise.all(
      (
        await db
          .select()
          .from(Rsvps)
          .where(eq(Rsvps.userId, currentUser.id))
          .all()
      ).map(async (rsvp) => {
        const event = await db
          .select()
          .from(Events)
          .where(eq(Events.id, rsvp.eventId))
          .get();

        return event ? { rsvp, event } : null;
      })
    )
  : [];

const validHistoryItems = historyItems
  .filter((item): item is NonNullable<typeof item> => item !== null)
  .sort((a, b) => new Date(b.event.dateTime).getTime() - new Date(a.event.dateTime).getTime());

function formatEventDate(date: Date): string {
  return new Intl.DateTimeFormat('no-NO', {
    timeZone: 'Europe/Oslo',
    weekday: 'short',
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  }).format(new Date(date));
}

function formatStatus(status: string): string {
  if (status === 'going') return 'Going';
  if (status === 'maybe') return 'Maybe';
  return 'Not Going';
}

function statusClass(status: string): string {
  if (status === 'going') return 'bg-[#e8f5e9] text-(--color-success)';
  if (status === 'maybe') return 'bg-[#fff3e0] text-(--color-warning)';
  return 'bg-[#ffebee] text-(--color-error)';
}
---

<Layout title="My RSVP History">
  <div class="mx-auto max-w-225 p-4 sm:p-6">
    <h1 class="mb-3 mt-0 text-[1.75rem] text-(--color-accent-dark) sm:text-[2.25rem]">My RSVP History</h1>
    <p class="mb-8 mt-0 text-(--color-text-secondary)">All events you have responded to, newest first.</p>

    {validHistoryItems.length === 0 && (
      <div class="rounded-lg border-2 border-dashed border-(--color-border) bg-white px-6 py-12 text-center text-(--color-text-muted)">
        <p class="m-0">You haven't RSVPd to any events yet.</p>
      </div>
    )}

    {validHistoryItems.length > 0 && (
      <ul class="m-0 list-none space-y-4 p-0">
        {validHistoryItems.map(({ rsvp, event }) => (
          <li data-test-id="history-item" class="rounded-lg border border-(--color-border) bg-white p-5">
            <a href={`/events/${event.id}`} class="block text-inherit no-underline">
              <div class="flex flex-wrap items-start justify-between gap-3">
                <h2 class="m-0 text-xl text-(--color-accent-dark)">{event.title}</h2>
                <span data-test-id="history-status" class={`rounded-full px-3 py-1 text-[0.85rem] font-medium ${statusClass(rsvp.status)}`}>
                  {formatStatus(rsvp.status)}
                </span>
              </div>
              <p class="mb-2 mt-3 text-[0.95rem] text-(--color-text-secondary)">{formatEventDate(event.dateTime)}</p>
              <p class="m-0 text-(--color-text-primary)">{event.location}</p>
            </a>
          </li>
        ))}
      </ul>
    )}
  </div>
</Layout>
