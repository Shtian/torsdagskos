---































import { db, Events, Rsvps, eq } from 'astro:db';
import Layout from '../layouts/Layout.astro';
import { ensureLocalUser } from '@/lib/local-user-sync';

const { userId } = Astro.locals.auth();

const currentUser = userId ? await ensureLocalUser(Astro, userId) : null;

const historyItems = currentUser
  ? await db
      .select({
        rsvp: {
          id: Rsvps.id,
          userId: Rsvps.userId,
          eventId: Rsvps.eventId,
          status: Rsvps.status,
          createdAt: Rsvps.createdAt,
          updatedAt: Rsvps.updatedAt,
        },
        event: {
          id: Events.id,
          title: Events.title,
          description: Events.description,
          dateTime: Events.dateTime,
          location: Events.location,
          mapLink: Events.mapLink,
          createdAt: Events.createdAt,
          ownerId: Events.ownerId,
        },
      })
      .from(Rsvps)
      .leftJoin(Events, eq(Rsvps.eventId, Events.id))
      .where(eq(Rsvps.userId, currentUser.id))
      .all()
  : [];

const _validHistoryItems = historyItems
  .filter(
    (
      item,
    ): item is (typeof historyItems)[number] & {
      event: NonNullable<(typeof historyItems)[number]['event']>;
    } => item.event !== null,
  )
  .sort(
    (a, b) =>
      new Date(b.event.dateTime).getTime() -
      new Date(a.event.dateTime).getTime(),
  );

function _formatEventDate(date: Date): string {
  return new Intl.DateTimeFormat('no-NO', {
    timeZone: 'Europe/Oslo',
    weekday: 'short',
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  }).format(new Date(date));
}

function _formatStatus(status: string): string {
  if (status === 'going') return 'Kommer';
  if (status === 'maybe') return 'Kanskje';
  return 'Kommer ikke';
}

function _statusClass(status: string): string {
  if (status === 'going')
    return 'border-emerald-200 bg-emerald-50 text-emerald-700';
  if (status === 'maybe') return 'border-amber-200 bg-amber-50 text-amber-700';
  return 'border-rose-200 bg-rose-50 text-rose-700';
}
---

<Layout
  title="Min svarhistorikk - Torsdagskos"
  description="Se svarhistorikken din på tvers av kommende og tidligere Torsdagskos-arrangementer."
>
  <section class="mx-auto mt-6 w-full max-w-5xl pb-8 sm:mt-10" data-test-id="history-shell">
    <div data-slot="card" class="bg-card text-card-foreground mb-6 rounded-xl border shadow-sm">
      <div data-slot="card-header" class="space-y-2 px-6 py-5 sm:px-8">
        <h1 class="m-0 text-3xl text-(--color-accent-dark) sm:text-4xl">Min svarhistorikk</h1>
        <p class="m-0 text-sm text-muted-foreground">Alle arrangementer du har svart på, nyeste først.</p>
      </div>
    </div>

    {_validHistoryItems.length === 0 && (
      <div
        data-test-id="history-empty-state"
        data-slot="card"
        class="bg-card text-card-foreground rounded-xl border border-dashed px-6 py-12 text-center shadow-sm sm:px-8"
      >
        <p class="m-0 text-base text-muted-foreground">Du har ikke svart på noen arrangementer ennå.</p>
      </div>
    )}

    {_validHistoryItems.length > 0 && (
      <ul class="m-0 list-none space-y-4 p-0">
        {_validHistoryItems.map(({ rsvp, event }) => (
          <li data-test-id="history-item" data-slot="card" class="bg-card text-card-foreground rounded-xl border shadow-sm">
            <a href={`/events/${event.id}`} class="block text-inherit no-underline">
              <div data-slot="card-content" class="space-y-3 px-6 py-5 sm:px-8">
                <div class="flex flex-wrap items-start justify-between gap-3">
                  <h2 class="m-0 text-xl text-(--color-accent-dark)">{event.title}</h2>
                  <span
                    data-test-id="history-status"
                    class={`inline-flex items-center rounded-full border px-3 py-1 text-[0.78rem] font-medium uppercase tracking-wide ${_statusClass(rsvp.status)}`}
                  >
                    {_formatStatus(rsvp.status)}
                  </span>
                </div>
                <p class="m-0 text-sm text-muted-foreground">{_formatEventDate(event.dateTime)}</p>
                <p class="m-0 text-foreground">{event.location}</p>
              </div>
            </a>
          </li>
        ))}
      </ul>
    )}
  </section>
</Layout>
