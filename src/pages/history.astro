---
import Layout from '../layouts/Layout.astro';
import { clerkClient } from '@clerk/astro/server';
import { db, Users, Events, Rsvps, eq } from 'astro:db';

const { userId } = Astro.locals.auth();

let currentUser = await db
  .select()
  .from(Users)
  .where(eq(Users.clerkUserId, userId!))
  .get();

// Keep this page resilient when users navigate here before homepage sync runs.
if (!currentUser && userId) {
  const clerkUser = await clerkClient(Astro).users.getUser(userId);

  try {
    await db.insert(Users).values({
      clerkUserId: userId,
      email: clerkUser.emailAddresses[0]?.emailAddress || '',
      name: `${clerkUser.firstName || ''} ${clerkUser.lastName || ''}`.trim() || clerkUser.emailAddresses[0]?.emailAddress || 'User',
      createdAt: new Date(),
    });
  } catch (error) {
    if (!(error instanceof Error && error.message.includes('UNIQUE constraint'))) {
      throw error;
    }
  }

  currentUser = await db
    .select()
    .from(Users)
    .where(eq(Users.clerkUserId, userId))
    .get();
}

const historyItems = currentUser
  ? await Promise.all(
      (
        await db
          .select()
          .from(Rsvps)
          .where(eq(Rsvps.userId, currentUser.id))
          .all()
      ).map(async (rsvp) => {
        const event = await db
          .select()
          .from(Events)
          .where(eq(Events.id, rsvp.eventId))
          .get();

        return event ? { rsvp, event } : null;
      })
    )
  : [];

const validHistoryItems = historyItems
  .filter((item): item is NonNullable<typeof item> => item !== null)
  .sort((a, b) => new Date(b.event.dateTime).getTime() - new Date(a.event.dateTime).getTime());

function formatEventDate(date: Date): string {
  return new Intl.DateTimeFormat('no-NO', {
    timeZone: 'Europe/Oslo',
    weekday: 'short',
    year: 'numeric',
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit',
  }).format(new Date(date));
}

function formatStatus(status: string): string {
  if (status === 'going') return 'Going';
  if (status === 'maybe') return 'Maybe';
  return 'Not Going';
}

function statusClass(status: string): string {
  if (status === 'going') return 'border-emerald-200 bg-emerald-50 text-emerald-700';
  if (status === 'maybe') return 'border-amber-200 bg-amber-50 text-amber-700';
  return 'border-rose-200 bg-rose-50 text-rose-700';
}
---

<Layout
  title="My RSVP History - Torsdagskos"
  description="Review your RSVP history across upcoming and past Torsdagskos events."
>
  <section class="mx-auto mt-6 w-full max-w-5xl px-4 pb-8 sm:mt-10 sm:px-6" data-test-id="history-shell">
    <div data-slot="card" class="bg-card text-card-foreground mb-6 rounded-xl border shadow-sm">
      <div data-slot="card-header" class="space-y-2 px-6 py-5 sm:px-8">
        <h1 class="m-0 text-3xl text-(--color-accent-dark) sm:text-4xl">My RSVP History</h1>
        <p class="m-0 text-sm text-muted-foreground">All events you have responded to, newest first.</p>
      </div>
    </div>

    {validHistoryItems.length === 0 && (
      <div
        data-test-id="history-empty-state"
        data-slot="card"
        class="bg-card text-card-foreground rounded-xl border border-dashed px-6 py-12 text-center shadow-sm"
      >
        <p class="m-0 text-base text-muted-foreground">You haven't RSVPd to any events yet.</p>
      </div>
    )}

    {validHistoryItems.length > 0 && (
      <ul class="m-0 list-none space-y-4 p-0">
        {validHistoryItems.map(({ rsvp, event }) => (
          <li data-test-id="history-item" data-slot="card" class="bg-card text-card-foreground rounded-xl border shadow-sm">
            <a href={`/events/${event.id}`} class="block text-inherit no-underline">
              <div data-slot="card-content" class="space-y-3 px-6 py-5 sm:px-8">
                <div class="flex flex-wrap items-start justify-between gap-3">
                  <h2 class="m-0 text-xl text-(--color-accent-dark)">{event.title}</h2>
                  <span
                    data-test-id="history-status"
                    class={`inline-flex items-center rounded-full border px-3 py-1 text-[0.78rem] font-medium uppercase tracking-wide ${statusClass(rsvp.status)}`}
                  >
                    {formatStatus(rsvp.status)}
                  </span>
                </div>
                <p class="m-0 text-sm text-muted-foreground">{formatEventDate(event.dateTime)}</p>
                <p class="m-0 text-foreground">{event.location}</p>
              </div>
            </a>
          </li>
        ))}
      </ul>
    )}
  </section>
</Layout>
