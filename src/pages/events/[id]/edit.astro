---
import Layout from '../../../layouts/Layout.astro';







import { db, Events, eq } from 'astro:db';
import { Button, Input, Label, Textarea } from '@/components/ui';
import { buttonVariants } from '@/components/ui/button';

const { id } = Astro.params;
const eventId = Number(id);

if (!Number.isFinite(eventId)) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

const event = await db
  .select()
  .from(Events)
  .where(eq(Events.id, eventId))
  .get();

if (!event) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

const isUpcoming = new Date(event.dateTime) >= new Date();
if (!isUpcoming) {
  return Astro.redirect(`/events/${event.id}`);
}

function getOsloDateInputValue(date: Date): string {
  const parts = new Intl.DateTimeFormat('en-CA', {
    timeZone: 'Europe/Oslo',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  }).formatToParts(new Date(date));

  const year = parts.find((part) => part.type === 'year')?.value;
  const month = parts.find((part) => part.type === 'month')?.value;
  const day = parts.find((part) => part.type === 'day')?.value;

  return `${year}-${month}-${day}`;
}

function getOsloTimeInputValue(date: Date): string {
  const parts = new Intl.DateTimeFormat('en-GB', {
    timeZone: 'Europe/Oslo',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  }).formatToParts(new Date(date));

  const hour = parts.find((part) => part.type === 'hour')?.value;
  const minute = parts.find((part) => part.type === 'minute')?.value;

  return `${hour}:${minute}`;
}

const prefillDate = getOsloDateInputValue(event.dateTime);
const prefillTime = getOsloTimeInputValue(event.dateTime);
---

<Layout
  title={`Rediger ${event.title} - Torsdagskos`}
  description={`Oppdater detaljer for ${event.title}, inkludert dato, sted og valgfri kartlenke.`}
>
  <section class="mx-auto mt-6 w-full max-w-4xl pb-8 sm:mt-10" data-test-id="edit-event-shell">
    <div class="mb-6">
      <a href={`/events/${event.id}`} class:list={[buttonVariants({ variant: 'ghost' }), 'pl-0 no-underline']}>&larr; Tilbake til arrangement</a>
    </div>

    <form id="event-form" data-slot="card" class="bg-card text-card-foreground rounded-xl border shadow-sm" novalidate>
      <input type="hidden" id="eventId" name="eventId" value={event.id} />
      <div data-slot="card-header" class="space-y-2 border-b px-6 py-5 sm:px-8">
        <h1 class="m-0 text-3xl text-(--color-accent-dark) sm:text-4xl">Rediger arrangement</h1>
        <p class="m-0 text-sm text-muted-foreground">
          Oppdater arrangementsdetaljene nedenfor. Felt merket med * er påkrevd.
        </p>
      </div>

      <div data-slot="card-content" class="space-y-6 px-6 py-6 sm:px-8">
        <div class="space-y-2">
          <Label htmlFor="title">
            Arrangementstittel <span class="text-destructive">*</span>
          </Label>
          <Input
            type="text"
            id="title"
            name="title"
            className="h-auto px-3 py-3"
            value={event.title}
          />
          <p id="title-error" data-test-id="field-error-title" class="hidden text-sm text-destructive" role="alert"></p>
        </div>

        <div class="space-y-2">
          <Label htmlFor="description">
            Beskrivelse
          </Label>
          <Textarea
            id="description"
            name="description"
            className="min-h-[120px] resize-y px-3 py-3"
            rows={5}
            defaultValue={event.description || ''}
          />
          <p id="description-error" data-test-id="field-error-description" class="hidden text-sm text-destructive" role="alert"></p>
        </div>

        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2">
          <div class="space-y-2">
            <Label htmlFor="date">
              Dato <span class="text-destructive">*</span>
            </Label>
            <Input
              type="date"
              id="date"
              name="date"
              className="h-auto px-3 py-3"
              value={prefillDate}
            />
            <p id="date-error" data-test-id="field-error-date" class="hidden text-sm text-destructive" role="alert"></p>
          </div>

          <div class="space-y-2">
            <Label htmlFor="time">
              Tid <span class="text-destructive">*</span>
            </Label>
            <Input
              type="time"
              id="time"
              name="time"
              className="h-auto px-3 py-3"
              value={prefillTime}
            />
            <p id="time-error" data-test-id="field-error-time" class="hidden text-sm text-destructive" role="alert"></p>
          </div>
        </div>

        <div class="space-y-2">
          <Label htmlFor="location">
            Sted <span class="text-destructive">*</span>
          </Label>
          <Input
            type="text"
            id="location"
            name="location"
            className="h-auto px-3 py-3"
            value={event.location}
          />
          <p id="location-error" data-test-id="field-error-location" class="hidden text-sm text-destructive" role="alert"></p>
        </div>

        <div class="space-y-2">
          <Label htmlFor="mapLink">
            Kartlenke <span class="text-sm font-normal text-muted-foreground">(valgfritt)</span>
          </Label>
          <Input
            type="url"
            id="mapLink"
            name="mapLink"
            className="h-auto px-3 py-3"
            value={event.mapLink || ''}
          />
          <p id="mapLink-error" data-test-id="field-error-mapLink" class="hidden text-sm text-destructive" role="alert"></p>
        </div>

        <div
          id="form-feedback-panel"
          data-test-id="form-feedback-panel"
          class="hidden rounded-md border px-4 py-3"
          role="status"
          aria-live="polite"
        >
          <p id="form-feedback" class="m-0 text-sm text-foreground"></p>
        </div>
      </div>

      <div data-slot="card-footer" class="flex flex-col gap-3 border-t px-6 py-5 sm:flex-row sm:px-8">
        <Button
          type="submit"
          id="submit-button"
          data-test-id="submit-edit-event-button"
          className="min-h-11 min-w-11 h-auto cursor-pointer px-6 py-3 text-base sm:w-auto"
        >
          Lagre endringer
        </Button>
        <a
          href={`/events/${event.id}`}
          class:list={[buttonVariants({ variant: 'outline', size: 'default' }), 'min-h-11 min-w-11 px-6 py-3 text-base no-underline sm:w-auto']}
        >
          Avbryt
        </a>
      </div>
    </form>
  </section>
</Layout>

<script>
  import { validateUpdateEventForm } from '@/lib/event-form-validation';

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('event-form') as HTMLFormElement;
    const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
    const feedbackPanel = document.getElementById('form-feedback-panel') as HTMLDivElement;
    const feedbackText = document.getElementById('form-feedback') as HTMLParagraphElement;
    const fieldErrors = {
      date: document.getElementById('date-error') as HTMLParagraphElement,
      description: document.getElementById('description-error') as HTMLParagraphElement,
      location: document.getElementById('location-error') as HTMLParagraphElement,
      mapLink: document.getElementById('mapLink-error') as HTMLParagraphElement,
      time: document.getElementById('time-error') as HTMLParagraphElement,
      title: document.getElementById('title-error') as HTMLParagraphElement,
    };
    const formFields = {
      date: document.getElementById('date') as HTMLInputElement,
      description: document.getElementById('description') as HTMLTextAreaElement,
      location: document.getElementById('location') as HTMLInputElement,
      mapLink: document.getElementById('mapLink') as HTMLInputElement,
      time: document.getElementById('time') as HTMLInputElement,
      title: document.getElementById('title') as HTMLInputElement,
    };
    const eventIdInput = document.getElementById('eventId') as HTMLInputElement;
    const defaultSubmitLabel = 'Lagre endringer';
    const loadingSubmitLabel = 'Lagrer...';

    if (!form || !submitButton || !feedbackPanel || !feedbackText || !eventIdInput) {
      return;
    }

    function setFeedback(message: string, type: 'idle' | 'loading' | 'success' | 'error') {
      if (type === 'idle') {
        feedbackPanel.className = 'hidden rounded-md border px-4 py-3';
        feedbackText.textContent = '';
        feedbackPanel.setAttribute('role', 'status');
        feedbackPanel.setAttribute('aria-live', 'polite');
        return;
      }

      const baseClasses = 'block rounded-md border px-4 py-3';

      if (type === 'loading') {
        feedbackPanel.className = `${baseClasses} border-border bg-muted/50`;
        feedbackPanel.setAttribute('role', 'status');
        feedbackPanel.setAttribute('aria-live', 'polite');
      } else if (type === 'success') {
        feedbackPanel.className = `${baseClasses} border-emerald-200 bg-emerald-50`;
        feedbackPanel.setAttribute('role', 'status');
        feedbackPanel.setAttribute('aria-live', 'polite');
      } else {
        feedbackPanel.className = `${baseClasses} border-destructive/30 bg-destructive/10`;
        feedbackPanel.setAttribute('role', 'alert');
        feedbackPanel.setAttribute('aria-live', 'assertive');
      }

      feedbackText.textContent = message;
    }

    function clearFieldErrors() {
      for (const [name, field] of Object.entries(formFields)) {
        field.removeAttribute('aria-invalid');
        field.removeAttribute('aria-describedby');
        fieldErrors[name as keyof typeof fieldErrors].className = 'hidden text-sm text-destructive';
        fieldErrors[name as keyof typeof fieldErrors].textContent = '';
      }
    }

    function setFieldError(fieldName: keyof typeof fieldErrors, message: string) {
      const errorElement = fieldErrors[fieldName];
      const field = formFields[fieldName];
      errorElement.className = 'block text-sm text-destructive';
      errorElement.textContent = message;
      field.setAttribute('aria-invalid', 'true');
      field.setAttribute('aria-describedby', errorElement.id);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const parsedForm = validateUpdateEventForm({
        date: formData.get('date'),
        description: formData.get('description'),
        eventId: eventIdInput.value,
        location: formData.get('location'),
        mapLink: formData.get('mapLink'),
        time: formData.get('time'),
        title: formData.get('title'),
      });

      clearFieldErrors();
      setFeedback('', 'idle');

      if (!parsedForm.success) {
        const fieldNames = Object.keys(formFields) as Array<keyof typeof formFields>;

        for (const fieldName of fieldNames) {
          const message = parsedForm.error.fieldErrors[fieldName]?.[0];
          if (message) {
            setFieldError(fieldName, message);
          }
        }

        setFeedback('Rett feltene som er markert og prøv igjen.', 'error');
        return;
      }

      const { eventId, title, description, date, time, location, mapLink } = parsedForm.data;
      const dateTimeString = `${date}T${time}:00`;
      const dateTime = new Date(dateTimeString);

      submitButton.disabled = true;
      submitButton.textContent = loadingSubmitLabel;
      submitButton.setAttribute('aria-busy', 'true');
      setFeedback('Lagrer endringer i arrangement...', 'loading');

      try {
        const response = await fetch('/api/events/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            eventId,
            title,
            description: description || '',
            dateTime: dateTime.toISOString(),
            location,
            mapLink: mapLink || null,
          }),
        });

        if (!response.ok) {
          const errorPayload = await response.json().catch(() => null);
          throw new Error(errorPayload?.error || 'Kunne ikke oppdatere arrangement');
        }

        const result = await response.json();

        setFeedback('Arrangement oppdatert. Videresender til detaljer...', 'success');

        setTimeout(() => {
          window.location.href = `/events/${result.eventId}`;
        }, 1000);
      } catch (error) {
        setFeedback(error instanceof Error ? error.message : 'Kunne ikke oppdatere arrangement. Prøv igjen.', 'error');
        submitButton.disabled = false;
        submitButton.textContent = defaultSubmitLabel;
        submitButton.removeAttribute('aria-busy');
      }
    });
  });
</script>
