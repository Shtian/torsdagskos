---



import { db, Events, eq } from 'astro:db';
import EditEventForm from '@/components/EditEventForm';
import { buttonVariants } from '@/components/ui/button';
import Layout from '../../../layouts/Layout.astro';

const { id } = Astro.params;
const eventId = Number(id);

if (!Number.isFinite(eventId)) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

const event = await db
  .select()
  .from(Events)
  .where(eq(Events.id, eventId))
  .get();

if (!event) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

const isUpcoming = new Date(event.dateTime) >= new Date();
if (!isUpcoming) {
  return Astro.redirect(`/events/${event.id}`);
}

function getOsloDateInputValue(date: Date): string {
  const parts = new Intl.DateTimeFormat('en-CA', {
    timeZone: 'Europe/Oslo',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  }).formatToParts(new Date(date));

  const year = parts.find((part) => part.type === 'year')?.value;
  const month = parts.find((part) => part.type === 'month')?.value;
  const day = parts.find((part) => part.type === 'day')?.value;

  return `${year}-${month}-${day}`;
}

function getOsloTimeInputValue(date: Date): string {
  const parts = new Intl.DateTimeFormat('en-GB', {
    timeZone: 'Europe/Oslo',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  }).formatToParts(new Date(date));

  const hour = parts.find((part) => part.type === 'hour')?.value;
  const minute = parts.find((part) => part.type === 'minute')?.value;

  return `${hour}:${minute}`;
}

const prefillDate = getOsloDateInputValue(event.dateTime);
const prefillTime = getOsloTimeInputValue(event.dateTime);
---

<Layout
  title={`Rediger ${event.title} - Torsdagskos`}
  description={`Oppdater detaljer for ${event.title}, inkludert dato, sted og valgfri kartlenke.`}
>
  <section class="mx-auto mt-6 w-full max-w-4xl pb-8 sm:mt-10" data-test-id="edit-event-shell">
    <div class="mb-6">
      <a href={`/events/${event.id}`} class:list={[buttonVariants({ variant: 'ghost' }), 'pl-0 no-underline']}>&larr; Tilbake til arrangement</a>
    </div>

    <EditEventForm
      client:load
      eventId={event.id}
      prefillTitle={event.title}
      prefillDescription={event.description || ''}
      prefillDate={prefillDate}
      prefillTime={prefillTime}
      prefillLocation={event.location}
      prefillMapLink={event.mapLink || ''}
      cancelHref={`/events/${event.id}`}
    />
  </section>
</Layout>
