---
import Layout from '../../../layouts/Layout.astro';
import { db, Events, eq } from 'astro:db';
import { Button, Input, Label, Textarea } from '@/components/ui';
import { buttonVariants } from '@/components/ui/button';

const { id } = Astro.params;
const eventId = Number(id);

if (!Number.isFinite(eventId)) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

const event = await db
  .select()
  .from(Events)
  .where(eq(Events.id, eventId))
  .get();

if (!event) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

const isUpcoming = new Date(event.dateTime) >= new Date();
if (!isUpcoming) {
  return Astro.redirect(`/events/${event.id}`);
}

function getOsloDateInputValue(date: Date): string {
  const parts = new Intl.DateTimeFormat('en-CA', {
    timeZone: 'Europe/Oslo',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
  }).formatToParts(new Date(date));

  const year = parts.find((part) => part.type === 'year')?.value;
  const month = parts.find((part) => part.type === 'month')?.value;
  const day = parts.find((part) => part.type === 'day')?.value;

  return `${year}-${month}-${day}`;
}

function getOsloTimeInputValue(date: Date): string {
  const parts = new Intl.DateTimeFormat('en-GB', {
    timeZone: 'Europe/Oslo',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  }).formatToParts(new Date(date));

  const hour = parts.find((part) => part.type === 'hour')?.value;
  const minute = parts.find((part) => part.type === 'minute')?.value;

  return `${hour}:${minute}`;
}

const prefillDate = getOsloDateInputValue(event.dateTime);
const prefillTime = getOsloTimeInputValue(event.dateTime);
---

<Layout
  title={`Edit ${event.title} - Torsdagskos`}
  description={`Update details for ${event.title}, including date, location, and optional map link.`}
>
  <section class="mx-auto mt-6 w-full max-w-4xl px-4 pb-8 sm:mt-10 sm:px-0" data-test-id="edit-event-shell">
    <div class="mb-6">
      <a href={`/events/${event.id}`} class:list={[buttonVariants({ variant: 'ghost' }), 'pl-0 no-underline']}>&larr; Back to Event</a>
    </div>

    <form id="event-form" data-slot="card" class="bg-card text-card-foreground rounded-xl border shadow-sm">
      <div data-slot="card-header" class="space-y-2 border-b px-6 py-5 sm:px-8">
        <h1 class="m-0 text-3xl text-(--color-accent-dark) sm:text-4xl">Edit Event</h1>
        <p class="m-0 text-sm text-muted-foreground">
          Update event details below. Fields marked with * are required.
        </p>
      </div>

      <div data-slot="card-content" class="space-y-6 px-6 py-6 sm:px-8">
        <div class="space-y-2">
          <Label htmlFor="title">
            Event Title <span class="text-destructive">*</span>
          </Label>
          <Input
            type="text"
            id="title"
            name="title"
            className="h-auto px-3 py-3"
            required
            value={event.title}
          />
        </div>

        <div class="space-y-2">
          <Label htmlFor="description">
            Description
          </Label>
          <Textarea
            id="description"
            name="description"
            className="min-h-[120px] resize-y px-3 py-3"
            rows={5}
            defaultValue={event.description || ''}
          />
        </div>

        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2">
          <div class="space-y-2">
            <Label htmlFor="date">
              Date <span class="text-destructive">*</span>
            </Label>
            <Input
              type="date"
              id="date"
              name="date"
              className="h-auto px-3 py-3"
              required
              value={prefillDate}
            />
          </div>

          <div class="space-y-2">
            <Label htmlFor="time">
              Time <span class="text-destructive">*</span>
            </Label>
            <Input
              type="time"
              id="time"
              name="time"
              className="h-auto px-3 py-3"
              required
              value={prefillTime}
            />
          </div>
        </div>

        <div class="space-y-2">
          <Label htmlFor="location">
            Location <span class="text-destructive">*</span>
          </Label>
          <Input
            type="text"
            id="location"
            name="location"
            className="h-auto px-3 py-3"
            required
            value={event.location}
          />
        </div>

        <div class="space-y-2">
          <Label htmlFor="mapLink">
            Map Link <span class="text-sm font-normal text-muted-foreground">(optional)</span>
          </Label>
          <Input
            type="url"
            id="mapLink"
            name="mapLink"
            className="h-auto px-3 py-3"
            value={event.mapLink || ''}
          />
        </div>

        <div
          id="form-feedback-panel"
          data-test-id="form-feedback-panel"
          class="hidden rounded-md border px-4 py-3"
          role="status"
          aria-live="polite"
        >
          <p id="form-feedback" class="m-0 text-sm text-foreground"></p>
        </div>
      </div>

      <div data-slot="card-footer" class="flex flex-col gap-3 border-t px-6 py-5 sm:flex-row sm:px-8">
        <Button
          type="submit"
          id="submit-button"
          data-test-id="submit-edit-event-button"
          className="touch-target h-auto cursor-pointer px-6 py-3 text-base sm:w-auto"
        >
          Save Changes
        </Button>
        <a
          href={`/events/${event.id}`}
          class:list={[buttonVariants({ variant: 'outline', size: 'default' }), 'touch-target px-6 py-3 text-base no-underline sm:w-auto']}
        >
          Cancel
        </a>
      </div>
    </form>
  </section>
</Layout>

<script is:inline define:vars={{ eventId }}>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('event-form');
    const submitButton = document.getElementById('submit-button');
    const feedbackPanel = document.getElementById('form-feedback-panel');
    const feedbackText = document.getElementById('form-feedback');
    const defaultSubmitLabel = 'Save Changes';
    const loadingSubmitLabel = 'Saving...';

    if (!form || !submitButton || !feedbackPanel || !feedbackText) {
      return;
    }

    function setFeedback(message, type) {
      if (type === 'idle') {
        feedbackPanel.className = 'hidden rounded-md border px-4 py-3';
        feedbackText.textContent = '';
        feedbackPanel.setAttribute('role', 'status');
        feedbackPanel.setAttribute('aria-live', 'polite');
        return;
      }

      const baseClasses = 'block rounded-md border px-4 py-3';

      if (type === 'loading') {
        feedbackPanel.className = `${baseClasses} border-border bg-muted/50`;
        feedbackPanel.setAttribute('role', 'status');
        feedbackPanel.setAttribute('aria-live', 'polite');
      } else if (type === 'success') {
        feedbackPanel.className = `${baseClasses} border-emerald-200 bg-emerald-50`;
        feedbackPanel.setAttribute('role', 'status');
        feedbackPanel.setAttribute('aria-live', 'polite');
      } else {
        feedbackPanel.className = `${baseClasses} border-destructive/30 bg-destructive/10`;
        feedbackPanel.setAttribute('role', 'alert');
        feedbackPanel.setAttribute('aria-live', 'assertive');
      }

      feedbackText.textContent = message;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const title = formData.get('title');
      const description = formData.get('description');
      const date = formData.get('date');
      const time = formData.get('time');
      const location = formData.get('location');
      const mapLink = formData.get('mapLink');

      if (!title || !date || !time || !location) {
        setFeedback('Please fill in all required fields.', 'error');
        return;
      }

      const dateTimeString = `${date}T${time}:00`;
      const dateTime = new Date(dateTimeString);

      submitButton.disabled = true;
      submitButton.textContent = loadingSubmitLabel;
      submitButton.setAttribute('aria-busy', 'true');
      setFeedback('Saving event changes...', 'loading');

      try {
        const response = await fetch('/api/events/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            eventId,
            title,
            description: description || '',
            dateTime: dateTime.toISOString(),
            location,
            mapLink: mapLink || null,
          }),
        });

        if (!response.ok) {
          const errorPayload = await response.json().catch(() => null);
          throw new Error(errorPayload?.error || 'Failed to update event');
        }

        const result = await response.json();

        setFeedback('Event updated successfully. Redirecting to details...', 'success');

        setTimeout(() => {
          window.location.href = `/events/${result.eventId}`;
        }, 1000);
      } catch (error) {
        setFeedback(error instanceof Error ? error.message : 'Failed to update event. Please try again.', 'error');
        submitButton.disabled = false;
        submitButton.textContent = defaultSubmitLabel;
        submitButton.removeAttribute('aria-busy');
      }
    });
  });
</script>
