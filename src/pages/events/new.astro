---
import Layout from '../../layouts/Layout.astro';
import { Button, Input, Label, Textarea } from '@/components/ui';
import { buttonVariants } from '@/components/ui/button';








// Ensure user is authenticated
const { userId } = Astro.locals.auth();
if (!userId) {
  return Astro.redirect('/sign-in');
}

// Check if this is a duplicate request
const isDuplicate = Astro.url.searchParams.get('duplicate') === 'true';
const prefillTitle = Astro.url.searchParams.get('title') || '';
const prefillDescription = Astro.url.searchParams.get('description') || '';
const prefillLocation = Astro.url.searchParams.get('location') || '';
const prefillMapLink = Astro.url.searchParams.get('mapLink') || '';
---

<Layout
  title="Opprett nytt arrangement - Torsdagskos"
  description="Opprett et nytt Torsdagskos-arrangement med tittel, dato, sted og valgfri informasjon."
>
  <section class="mx-auto mt-6 w-full max-w-4xl pb-8 sm:mt-10" data-test-id="new-event-shell">
    <div class="mb-6">
      <a href="/" class:list={[buttonVariants({ variant: 'ghost' }), 'pl-0 no-underline']}>&larr; Tilbake til arrangementer</a>
    </div>

    {isDuplicate && (
      <div
        data-slot="card"
        data-test-id="duplicate-banner"
        class="bg-primary/5 text-card-foreground mb-6 rounded-xl border border-primary/30 px-5 py-4 shadow-sm"
      >
        <p class="m-0 text-sm font-medium text-foreground">
          Duplisert fra forrige arrangement
        </p>
        <p class="mt-1 mb-0 text-sm text-muted-foreground">
          Tittel, beskrivelse, sted og kartlenke ble forhåndsutfylt.
          Angi dato og klokkeslett for dette arrangementet.
        </p>
      </div>
    )}

    <form id="event-form" data-slot="card" class="bg-card text-card-foreground rounded-xl border shadow-sm" novalidate>
      <div data-slot="card-header" class="space-y-2 border-b px-6 py-5 sm:px-8">
        <h1 class="m-0 text-3xl text-(--color-accent-dark) sm:text-4xl">Opprett nytt arrangement</h1>
        <p class="m-0 text-sm text-muted-foreground">
          Fyll ut arrangementsdetaljene nedenfor. Felt merket med * er påkrevd.
        </p>
      </div>

      <div data-slot="card-content" class="space-y-6 px-6 py-6 sm:px-8">
        <div class="space-y-2">
          <Label htmlFor="title">
            Arrangementstittel <span class="text-destructive">*</span>
          </Label>
          <Input
            type="text"
            id="title"
            name="title"
            className="h-auto px-3 py-3"
            placeholder="f.eks. Torsdagskos hos Ola"
            value={prefillTitle}
          />
          <p id="title-error" data-test-id="field-error-title" class="hidden text-sm text-destructive" role="alert"></p>
        </div>

        <div class="space-y-2">
          <Label htmlFor="description">
            Beskrivelse
          </Label>
          <Textarea
            id="description"
            name="description"
            className="min-h-[120px] resize-y px-3 py-3"
            rows={5}
            placeholder="Hva er planen? Noen spesielle detaljer?"
            defaultValue={prefillDescription}
          />
          <p id="description-error" data-test-id="field-error-description" class="hidden text-sm text-destructive" role="alert"></p>
        </div>

        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2">
          <div class="space-y-2">
            <Label htmlFor="date">
              Dato <span class="text-destructive">*</span>
            </Label>
            <Input
              type="date"
              id="date"
              name="date"
              className="h-auto px-3 py-3"
            />
            <p id="date-error" data-test-id="field-error-date" class="hidden text-sm text-destructive" role="alert"></p>
          </div>

          <div class="space-y-2">
            <Label htmlFor="time">
              Tid <span class="text-destructive">*</span>
            </Label>
            <Input
              type="time"
              id="time"
              name="time"
              className="h-auto px-3 py-3"
            />
            <p id="time-error" data-test-id="field-error-time" class="hidden text-sm text-destructive" role="alert"></p>
          </div>
        </div>

        <div class="space-y-2">
          <Label htmlFor="location">
            Sted <span class="text-destructive">*</span>
          </Label>
          <Input
            type="text"
            id="location"
            name="location"
            className="h-auto px-3 py-3"
            placeholder="f.eks. Olas leilighet, Oslo sentrum"
            value={prefillLocation}
          />
          <p id="location-error" data-test-id="field-error-location" class="hidden text-sm text-destructive" role="alert"></p>
        </div>

        <div class="space-y-2">
          <Label htmlFor="mapLink">
            Kartlenke <span class="text-sm font-normal text-muted-foreground">(valgfritt)</span>
          </Label>
          <Input
            type="url"
            id="mapLink"
            name="mapLink"
            className="h-auto px-3 py-3"
            placeholder="https://maps.google.com/..."
            value={prefillMapLink}
          />
          <p id="mapLink-error" data-test-id="field-error-mapLink" class="hidden text-sm text-destructive" role="alert"></p>
        </div>

        <div
          id="form-feedback-panel"
          data-test-id="form-feedback-panel"
          class="hidden rounded-md border px-4 py-3"
          role="status"
          aria-live="polite"
        >
          <p id="form-feedback" class="m-0 text-sm text-foreground"></p>
        </div>
      </div>

      <div data-slot="card-footer" class="flex flex-col gap-3 border-t px-6 py-5 sm:flex-row sm:px-8">
        <Button
          type="submit"
          id="submit-button"
          data-test-id="submit-event-button"
          className="min-h-11 min-w-11 h-auto cursor-pointer px-6 py-3 text-base sm:w-auto"
        >
          Opprett arrangement
        </Button>
        <a
          href="/"
          class:list={[buttonVariants({ variant: 'outline', size: 'default' }), 'min-h-11 min-w-11 px-6 py-3 text-base no-underline sm:w-auto']}
        >
          Avbryt
        </a>
      </div>
    </form>
  </section>
</Layout>

<script>
  import { validateCreateEventForm } from '@/lib/event-form-validation';
  import { parseOsloDateTimeInput } from '@/lib/oslo-datetime';

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('event-form') as HTMLFormElement;
    const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
    const feedbackPanel = document.getElementById('form-feedback-panel') as HTMLDivElement;
    const feedbackText = document.getElementById('form-feedback') as HTMLParagraphElement;
    const fieldErrors = {
      date: document.getElementById('date-error') as HTMLParagraphElement,
      description: document.getElementById('description-error') as HTMLParagraphElement,
      location: document.getElementById('location-error') as HTMLParagraphElement,
      mapLink: document.getElementById('mapLink-error') as HTMLParagraphElement,
      time: document.getElementById('time-error') as HTMLParagraphElement,
      title: document.getElementById('title-error') as HTMLParagraphElement,
    };
    const formFields = {
      date: document.getElementById('date') as HTMLInputElement,
      description: document.getElementById('description') as HTMLTextAreaElement,
      location: document.getElementById('location') as HTMLInputElement,
      mapLink: document.getElementById('mapLink') as HTMLInputElement,
      time: document.getElementById('time') as HTMLInputElement,
      title: document.getElementById('title') as HTMLInputElement,
    };
    const defaultSubmitLabel = 'Opprett arrangement';
    const loadingSubmitLabel = 'Oppretter...';

    function setFeedback(message: string, type: 'idle' | 'loading' | 'success' | 'error') {
      if (type === 'idle') {
        feedbackPanel.className = 'hidden rounded-md border px-4 py-3';
        feedbackText.textContent = '';
        feedbackPanel.setAttribute('role', 'status');
        feedbackPanel.setAttribute('aria-live', 'polite');
        return;
      }

      const baseClasses = 'block rounded-md border px-4 py-3';

      if (type === 'loading') {
        feedbackPanel.className = `${baseClasses} border-border bg-muted/50`;
        feedbackPanel.setAttribute('role', 'status');
        feedbackPanel.setAttribute('aria-live', 'polite');
      } else if (type === 'success') {
        feedbackPanel.className = `${baseClasses} border-emerald-200 bg-emerald-50`;
        feedbackPanel.setAttribute('role', 'status');
        feedbackPanel.setAttribute('aria-live', 'polite');
      } else {
        feedbackPanel.className = `${baseClasses} border-destructive/30 bg-destructive/10`;
        feedbackPanel.setAttribute('role', 'alert');
        feedbackPanel.setAttribute('aria-live', 'assertive');
      }

      feedbackText.textContent = message;
    }

    function clearFieldErrors() {
      for (const [name, field] of Object.entries(formFields)) {
        field.removeAttribute('aria-invalid');
        field.removeAttribute('aria-describedby');
        fieldErrors[name as keyof typeof fieldErrors].className = 'hidden text-sm text-destructive';
        fieldErrors[name as keyof typeof fieldErrors].textContent = '';
      }
    }

    function setFieldError(fieldName: keyof typeof fieldErrors, message: string) {
      const errorElement = fieldErrors[fieldName];
      const field = formFields[fieldName];
      errorElement.className = 'block text-sm text-destructive';
      errorElement.textContent = message;
      field.setAttribute('aria-invalid', 'true');
      field.setAttribute('aria-describedby', errorElement.id);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const parsedForm = validateCreateEventForm({
        date: formData.get('date'),
        description: formData.get('description'),
        location: formData.get('location'),
        mapLink: formData.get('mapLink'),
        time: formData.get('time'),
        title: formData.get('title'),
      });

      clearFieldErrors();
      setFeedback('', 'idle');

      if (!parsedForm.success) {
        const fieldNames = Object.keys(formFields) as Array<keyof typeof formFields>;

        for (const fieldName of fieldNames) {
          const message = parsedForm.error.fieldErrors[fieldName]?.[0];
          if (message) {
            setFieldError(fieldName, message);
          }
        }

        setFeedback('Rett feltene som er markert og prøv igjen.', 'error');
        return;
      }

      const { title, description, date, time, location, mapLink } = parsedForm.data;

      // Interpret submitted date/time as Europe/Oslo wall time.
      const dateTime = parseOsloDateTimeInput(date, time);

      // Disable submit button during submission
      submitButton.disabled = true;
      submitButton.textContent = loadingSubmitLabel;
      submitButton.setAttribute('aria-busy', 'true');
      setFeedback('Oppretter arrangement...', 'loading');

      try {
        const response = await fetch('/api/events/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            title,
            description: description || '',
            dateTime: dateTime.toISOString(),
            location,
            mapLink: mapLink || null,
          }),
        });

        if (!response.ok) {
          const errorPayload = await response.json().catch(() => null);
          throw new Error(errorPayload?.error || 'Kunne ikke opprette arrangement');
        }

        const result = await response.json();

        setFeedback('Arrangement opprettet. Videresender til detaljer...', 'success');

        // Redirect to event detail page after short delay
        setTimeout(() => {
          window.location.href = `/events/${result.eventId}`;
        }, 1000);
      } catch (error) {
        setFeedback(error instanceof Error ? error.message : 'Kunne ikke opprette arrangement. Prøv igjen.', 'error');

        // Re-enable submit button on error
        submitButton.disabled = false;
        submitButton.textContent = defaultSubmitLabel;
        submitButton.removeAttribute('aria-busy');
      }
    });
  });
</script>
