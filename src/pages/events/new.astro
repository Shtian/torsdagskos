---
import Layout from '../../layouts/Layout.astro';
import { Button, Input, Label, Textarea } from '@/components/ui';
import { buttonVariants } from '@/components/ui/button';

// Ensure user is authenticated
const { userId } = Astro.locals.auth();
if (!userId) {
  return Astro.redirect('/sign-in');
}

// Check if this is a duplicate request
const isDuplicate = Astro.url.searchParams.get('duplicate') === 'true';
const prefillTitle = Astro.url.searchParams.get('title') || '';
const prefillDescription = Astro.url.searchParams.get('description') || '';
const prefillLocation = Astro.url.searchParams.get('location') || '';
const prefillMapLink = Astro.url.searchParams.get('mapLink') || '';
---

<Layout
  title="Create New Event - Torsdagskos"
  description="Create a new Torsdagskos event with title, date, location, and optional details."
>
  <section class="mx-auto mt-6 w-full max-w-4xl px-4 pb-8 sm:mt-10 sm:px-0" data-test-id="new-event-shell">
    <div class="mb-6">
      <a href="/" class:list={[buttonVariants({ variant: 'ghost' }), 'pl-0 no-underline']}>&larr; Back to Events</a>
    </div>

    {isDuplicate && (
      <div
        data-slot="card"
        data-test-id="duplicate-banner"
        class="bg-primary/5 text-card-foreground mb-6 rounded-xl border border-primary/30 px-5 py-4 shadow-sm"
      >
        <p class="m-0 text-sm font-medium text-foreground">
          Duplicated from last event
        </p>
        <p class="mt-1 mb-0 text-sm text-muted-foreground">
          Title, description, location, and map link were pre-filled.
          Please set date and time for this event.
        </p>
      </div>
    )}

    <form id="event-form" data-slot="card" class="bg-card text-card-foreground rounded-xl border shadow-sm">
      <div data-slot="card-header" class="space-y-2 border-b px-6 py-5 sm:px-8">
        <h1 class="m-0 text-3xl text-(--color-accent-dark) sm:text-4xl">Create New Event</h1>
        <p class="m-0 text-sm text-muted-foreground">
          Fill out the event details below. Fields marked with * are required.
        </p>
      </div>

      <div data-slot="card-content" class="space-y-6 px-6 py-6 sm:px-8">
        <div class="space-y-2">
          <Label htmlFor="title">
            Event Title <span class="text-destructive">*</span>
          </Label>
          <Input
            type="text"
            id="title"
            name="title"
            className="h-auto px-3 py-3"
            required
            placeholder="e.g., Torsdagskos at John's place"
            value={prefillTitle}
          />
        </div>

        <div class="space-y-2">
          <Label htmlFor="description">
            Description
          </Label>
          <Textarea
            id="description"
            name="description"
            className="min-h-[120px] resize-y px-3 py-3"
            rows={5}
            placeholder="What's the plan? Any special details?"
            defaultValue={prefillDescription}
          />
        </div>

        <div class="grid grid-cols-1 gap-5 sm:grid-cols-2">
          <div class="space-y-2">
            <Label htmlFor="date">
              Date <span class="text-destructive">*</span>
            </Label>
            <Input
              type="date"
              id="date"
              name="date"
              className="h-auto px-3 py-3"
              required
            />
          </div>

          <div class="space-y-2">
            <Label htmlFor="time">
              Time <span class="text-destructive">*</span>
            </Label>
            <Input
              type="time"
              id="time"
              name="time"
              className="h-auto px-3 py-3"
              required
            />
          </div>
        </div>

        <div class="space-y-2">
          <Label htmlFor="location">
            Location <span class="text-destructive">*</span>
          </Label>
          <Input
            type="text"
            id="location"
            name="location"
            className="h-auto px-3 py-3"
            required
            placeholder="e.g., John's apartment, Oslo City Center"
            value={prefillLocation}
          />
        </div>

        <div class="space-y-2">
          <Label htmlFor="mapLink">
            Map Link <span class="text-sm font-normal text-muted-foreground">(optional)</span>
          </Label>
          <Input
            type="url"
            id="mapLink"
            name="mapLink"
            className="h-auto px-3 py-3"
            placeholder="https://maps.google.com/..."
            value={prefillMapLink}
          />
        </div>

        <div
          id="form-feedback-panel"
          data-test-id="form-feedback-panel"
          class="hidden rounded-md border px-4 py-3"
          role="status"
          aria-live="polite"
        >
          <p id="form-feedback" class="m-0 text-sm text-foreground"></p>
        </div>
      </div>

      <div data-slot="card-footer" class="flex flex-col gap-3 border-t px-6 py-5 sm:flex-row sm:px-8">
        <Button
          type="submit"
          id="submit-button"
          data-test-id="submit-event-button"
          className="touch-target h-auto cursor-pointer px-6 py-3 text-base sm:w-auto"
        >
          Create Event
        </Button>
        <a
          href="/"
          class:list={[buttonVariants({ variant: 'outline', size: 'default' }), 'touch-target px-6 py-3 text-base no-underline sm:w-auto']}
        >
          Cancel
        </a>
      </div>
    </form>
  </section>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('event-form') as HTMLFormElement;
    const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
    const feedbackPanel = document.getElementById('form-feedback-panel') as HTMLDivElement;
    const feedbackText = document.getElementById('form-feedback') as HTMLParagraphElement;
    const defaultSubmitLabel = 'Create Event';
    const loadingSubmitLabel = 'Creating...';

    function setFeedback(message: string, type: 'idle' | 'loading' | 'success' | 'error') {
      if (type === 'idle') {
        feedbackPanel.className = 'hidden rounded-md border px-4 py-3';
        feedbackText.textContent = '';
        feedbackPanel.setAttribute('role', 'status');
        feedbackPanel.setAttribute('aria-live', 'polite');
        return;
      }

      const baseClasses = 'block rounded-md border px-4 py-3';

      if (type === 'loading') {
        feedbackPanel.className = `${baseClasses} border-border bg-muted/50`;
        feedbackPanel.setAttribute('role', 'status');
        feedbackPanel.setAttribute('aria-live', 'polite');
      } else if (type === 'success') {
        feedbackPanel.className = `${baseClasses} border-emerald-200 bg-emerald-50`;
        feedbackPanel.setAttribute('role', 'status');
        feedbackPanel.setAttribute('aria-live', 'polite');
      } else {
        feedbackPanel.className = `${baseClasses} border-destructive/30 bg-destructive/10`;
        feedbackPanel.setAttribute('role', 'alert');
        feedbackPanel.setAttribute('aria-live', 'assertive');
      }

      feedbackText.textContent = message;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const formData = new FormData(form);
      const title = formData.get('title') as string;
      const description = formData.get('description') as string;
      const date = formData.get('date') as string;
      const time = formData.get('time') as string;
      const location = formData.get('location') as string;
      const mapLink = formData.get('mapLink') as string;

      // Validate required fields
      if (!title || !date || !time || !location) {
        setFeedback('Please fill in all required fields.', 'error');
        return;
      }

      // Combine date and time into ISO string (Europe/Oslo timezone)
      // The date/time input values are in local timezone, so we need to interpret them as Europe/Oslo
      const dateTimeString = `${date}T${time}:00`;
      const dateTime = new Date(dateTimeString);

      // Disable submit button during submission
      submitButton.disabled = true;
      submitButton.textContent = loadingSubmitLabel;
      submitButton.setAttribute('aria-busy', 'true');
      setFeedback('Creating event...', 'loading');

      try {
        const response = await fetch('/api/events/create', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            title,
            description: description || '',
            dateTime: dateTime.toISOString(),
            location,
            mapLink: mapLink || null,
          }),
        });

        if (!response.ok) {
          const errorPayload = await response.json().catch(() => null);
          throw new Error(errorPayload?.error || 'Failed to create event');
        }

        const result = await response.json();

        setFeedback('Event created successfully. Redirecting to details...', 'success');

        // Redirect to event detail page after short delay
        setTimeout(() => {
          window.location.href = `/events/${result.eventId}`;
        }, 1000);
      } catch (error) {
        setFeedback(error instanceof Error ? error.message : 'Failed to create event. Please try again.', 'error');

        // Re-enable submit button on error
        submitButton.disabled = false;
        submitButton.textContent = defaultSubmitLabel;
        submitButton.removeAttribute('aria-busy');
      }
    });
  });
</script>
