---
import Layout from '../../layouts/Layout.astro';
import { db, Users, Events, Rsvps, eq } from 'astro:db';
import { buttonVariants } from '@/components/ui/button';

const { id } = Astro.params;
const { userId } = Astro.locals.auth();

// Fetch event
const event = await db
  .select()
  .from(Events)
  .where(eq(Events.id, Number(id)))
  .get();

// Return 404 if event not found
if (!event) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

// Fetch all RSVPs with user information
const rsvps = await db
  .select()
  .from(Rsvps)
  .where(eq(Rsvps.eventId, event.id))
  .all();

// Get user details for all RSVPs
const rsvpsWithUsers = await Promise.all(
  rsvps.map(async (rsvp) => {
    const user = await db
      .select()
      .from(Users)
      .where(eq(Users.id, rsvp.userId))
      .get();
    return { ...rsvp, user };
  })
);

// Get current user's local database ID
const currentUser = await db
  .select()
  .from(Users)
  .where(eq(Users.clerkUserId, userId!))
  .get();

// Find current user's RSVP
const currentUserRsvp = rsvpsWithUsers.find(r => r.userId === currentUser?.id);

// Calculate RSVP counts
const goingRsvps = rsvpsWithUsers.filter(r => r.status === 'going');
const maybeRsvps = rsvpsWithUsers.filter(r => r.status === 'maybe');
const notGoingRsvps = rsvpsWithUsers.filter(r => r.status === 'not_going');

// Calculate no response count (total users - users who RSVPd)
const totalUsers = await db.select().from(Users).all();
const noResponseCount = totalUsers.length - rsvpsWithUsers.length;

// Format date in Europe/Oslo timezone
function formatEventDate(date: Date): string {
  return new Intl.DateTimeFormat('no-NO', {
    timeZone: 'Europe/Oslo',
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  }).format(new Date(date));
}

// Check if event is upcoming (not past)
const now = new Date();
const isUpcoming = new Date(event.dateTime) >= now;
---

<Layout
  title={`${event.title} - Torsdagskos`}
  description={`View details and RSVP options for ${event.title} at ${event.location}.`}
>
  <section class="mx-auto mt-6 w-full max-w-6xl px-4 pb-8 sm:mt-10 sm:px-6" data-test-id="event-detail-shell">
    <div class="mb-6">
      <a href="/" class:list={[buttonVariants({ variant: 'ghost' }), 'pl-0 no-underline']}>&larr; Back to Events</a>
    </div>

    <div data-slot="card" class="bg-card text-card-foreground mb-6 rounded-xl border shadow-sm">
      <div data-slot="card-header" class="space-y-2 border-b px-6 py-5 sm:px-8">
        <h1 class="m-0 text-3xl text-(--color-accent-dark) sm:text-4xl">{event.title}</h1>
        <p class="m-0 text-sm text-muted-foreground">{formatEventDate(event.dateTime)}</p>
      </div>
      {isUpcoming && (
        <div data-slot="card-footer" class="flex border-t px-6 py-4 sm:px-8">
          <a
            href={`/events/${event.id}/edit`}
            class:list={[buttonVariants({ variant: 'outline', size: 'default' }), 'touch-target no-underline']}
          >
            Edit Event
          </a>
        </div>
      )}
    </div>

    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2">
      <div data-slot="card" class="bg-card text-card-foreground rounded-xl border shadow-sm">
        <div data-slot="card-header" class="px-6 pt-5 pb-3 sm:px-8">
          <h2 class="m-0 text-xl text-(--color-accent-dark)">Event Details</h2>
        </div>
        <div data-slot="card-content" class="space-y-6 px-6 pb-6 sm:px-8 sm:pb-8">
          <div class="space-y-2">
            <h3 class="m-0 text-base font-semibold text-foreground">Description</h3>
            <p class="m-0 whitespace-pre-wrap leading-relaxed text-foreground">{event.description || 'No description provided.'}</p>
          </div>

          <div class="border-t pt-6">
            <h3 class="mb-2 mt-0 text-base font-semibold text-foreground">Location</h3>
            <p class="m-0 text-foreground">{event.location}</p>
            {event.mapLink && (
              <a
                href={event.mapLink}
                target="_blank"
                rel="noopener noreferrer"
                class:list={[buttonVariants({ variant: 'ghost', size: 'sm' }), 'mt-2 -ml-3 no-underline']}
              >
                Open in Maps &rarr;
              </a>
            )}
          </div>
        </div>
      </div>

      <div data-slot="card" class="bg-card text-card-foreground rounded-xl border shadow-sm">
        <div data-slot="card-header" class="px-6 pt-5 pb-3 sm:px-8">
          <h2 class="m-0 text-xl text-(--color-accent-dark)">RSVPs</h2>
        </div>

        <div data-slot="card-content" class="space-y-6 px-6 pb-6 sm:px-8 sm:pb-8">
          {isUpcoming && (
            <div class="flex flex-wrap gap-2.5">
              <button
                class:list={[
                  buttonVariants({ variant: 'outline', size: 'default' }),
                  'touch-target min-w-30 flex-1 cursor-pointer px-3 py-2.5 text-sm sm:text-base',
                  currentUserRsvp?.status === 'going' && 'border-emerald-300 bg-emerald-50 text-emerald-700 hover:bg-emerald-100'
                ]}
                data-slot="button"
                data-rsvp-button="true"
                data-status="going"
                data-active={currentUserRsvp?.status === 'going' ? 'true' : 'false'}
                data-event-id={event.id}
              >
                Going
              </button>
              <button
                class:list={[
                  buttonVariants({ variant: 'outline', size: 'default' }),
                  'touch-target min-w-30 flex-1 cursor-pointer px-3 py-2.5 text-sm sm:text-base',
                  currentUserRsvp?.status === 'maybe' && 'border-amber-300 bg-amber-50 text-amber-700 hover:bg-amber-100'
                ]}
                data-slot="button"
                data-rsvp-button="true"
                data-status="maybe"
                data-active={currentUserRsvp?.status === 'maybe' ? 'true' : 'false'}
                data-event-id={event.id}
              >
                Maybe
              </button>
              <button
                class:list={[
                  buttonVariants({ variant: 'outline', size: 'default' }),
                  'touch-target min-w-30 flex-1 cursor-pointer px-3 py-2.5 text-sm sm:text-base',
                  currentUserRsvp?.status === 'not_going' && 'border-rose-300 bg-rose-50 text-rose-700 hover:bg-rose-100'
                ]}
                data-slot="button"
                data-rsvp-button="true"
                data-status="not_going"
                data-active={currentUserRsvp?.status === 'not_going' ? 'true' : 'false'}
                data-event-id={event.id}
              >
                Not Going
              </button>
            </div>
          )}

          <div
            id="rsvp-feedback-panel"
            data-test-id="rsvp-feedback-panel"
            class="hidden rounded-md border px-4 py-3"
            role="status"
            aria-live="polite"
          >
            <p id="rsvp-feedback" class="m-0 text-sm text-foreground"></p>
          </div>

          {!isUpcoming && (
            <div data-test-id="past-event-notice" class="rounded-md border bg-muted/60 p-4 text-center italic text-muted-foreground">
              This event has passed. RSVPs are no longer available.
            </div>
          )}

          {currentUserRsvp && (
            <div data-test-id="current-user-rsvp" class="flex flex-wrap items-center gap-3 rounded-md border border-primary/30 bg-primary/5 px-4 py-3">
              <strong class="text-sm text-foreground">Your status:</strong>
              <span
                class:list={[
                  'inline-flex items-center rounded-full border px-3 py-1 text-xs font-medium sm:text-sm',
                  currentUserRsvp.status === 'going' && 'border-emerald-200 bg-emerald-50 text-emerald-700',
                  currentUserRsvp.status === 'maybe' && 'border-amber-200 bg-amber-50 text-amber-700',
                  currentUserRsvp.status === 'not_going' && 'border-rose-200 bg-rose-50 text-rose-700',
                ]}
              >
                {currentUserRsvp.status === 'going' && 'Going'}
                {currentUserRsvp.status === 'maybe' && 'Maybe'}
                {currentUserRsvp.status === 'not_going' && 'Not Going'}
              </span>
            </div>
          )}

          {!currentUserRsvp && (
            <div data-test-id="current-user-rsvp" class="flex flex-wrap items-center gap-3 rounded-md border px-4 py-3">
              <strong class="text-sm text-foreground">Your status:</strong>
              <span class="inline-flex items-center rounded-full border bg-muted px-3 py-1 text-xs font-medium text-muted-foreground sm:text-sm">No Response</span>
            </div>
          )}

          <div data-test-id="rsvp-counts" class="grid grid-cols-2 gap-3 sm:grid-cols-4">
            <div data-test-id="rsvp-count-item" data-rsvp-type="going" class="rounded-lg border bg-primary/5 p-3 text-center">
              <span data-test-id="rsvp-count-value" class="mb-1 block text-2xl font-semibold text-(--color-accent-dark)">{goingRsvps.length}</span>
              <span class="block text-[0.72rem] uppercase tracking-wide text-muted-foreground">Going</span>
            </div>
            <div data-test-id="rsvp-count-item" data-rsvp-type="maybe" class="rounded-lg border bg-primary/5 p-3 text-center">
              <span data-test-id="rsvp-count-value" class="mb-1 block text-2xl font-semibold text-(--color-accent-dark)">{maybeRsvps.length}</span>
              <span class="block text-[0.72rem] uppercase tracking-wide text-muted-foreground">Maybe</span>
            </div>
            <div data-test-id="rsvp-count-item" data-rsvp-type="not_going" class="rounded-lg border bg-primary/5 p-3 text-center">
              <span data-test-id="rsvp-count-value" class="mb-1 block text-2xl font-semibold text-(--color-accent-dark)">{notGoingRsvps.length}</span>
              <span class="block text-[0.72rem] uppercase tracking-wide text-muted-foreground">Not Going</span>
            </div>
            <div data-test-id="rsvp-count-item" data-rsvp-type="no_response" class="rounded-lg border bg-primary/5 p-3 text-center">
              <span data-test-id="rsvp-count-value" class="mb-1 block text-2xl font-semibold text-(--color-accent-dark)">{noResponseCount}</span>
              <span class="block text-[0.72rem] uppercase tracking-wide text-muted-foreground">No Response</span>
            </div>
          </div>

          {goingRsvps.length > 0 && (
            <div class="space-y-2">
              <h3 class="m-0 text-base font-semibold text-foreground">Going ({goingRsvps.length})</h3>
              <ul class="m-0 list-none space-y-2 p-0">
                {goingRsvps.map(rsvp => (
                  <li class="rounded-md border bg-primary/5 px-3 py-2 text-sm text-foreground">{rsvp.user?.name}</li>
                ))}
              </ul>
            </div>
          )}

          {maybeRsvps.length > 0 && (
            <div class="space-y-2">
              <h3 class="m-0 text-base font-semibold text-foreground">Maybe ({maybeRsvps.length})</h3>
              <ul class="m-0 list-none space-y-2 p-0">
                {maybeRsvps.map(rsvp => (
                  <li class="rounded-md border bg-primary/5 px-3 py-2 text-sm text-foreground">{rsvp.user?.name}</li>
                ))}
              </ul>
            </div>
          )}

          {notGoingRsvps.length > 0 && (
            <div class="space-y-2">
              <h3 class="m-0 text-base font-semibold text-foreground">Not Going ({notGoingRsvps.length})</h3>
              <ul class="m-0 list-none space-y-2 p-0">
                {notGoingRsvps.map(rsvp => (
                  <li class="rounded-md border bg-primary/5 px-3 py-2 text-sm text-foreground">{rsvp.user?.name}</li>
                ))}
              </ul>
            </div>
          )}
        </div>
      </div>
    </div>
  </section>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const rsvpButtons = document.querySelectorAll('[data-rsvp-button]');
    const feedbackPanel = document.getElementById('rsvp-feedback-panel');
    const feedback = document.getElementById('rsvp-feedback');

    if (!feedbackPanel || !feedback) {
      return;
    }
    const feedbackPanelElement = feedbackPanel as HTMLDivElement;
    const feedbackElement = feedback as HTMLParagraphElement;

    function setFeedback(text: string, type: 'idle' | 'loading' | 'success' | 'error') {
      if (type === 'idle') {
        feedbackPanelElement.className = 'hidden rounded-md border px-4 py-3';
        feedbackElement.textContent = '';
        feedbackPanelElement.setAttribute('role', 'status');
        feedbackPanelElement.setAttribute('aria-live', 'polite');
        return;
      }

      const baseClasses = 'block rounded-md border px-4 py-3';
      if (type === 'loading') {
        feedbackPanelElement.className = `${baseClasses} border-border bg-muted/50`;
        feedbackPanelElement.setAttribute('role', 'status');
        feedbackPanelElement.setAttribute('aria-live', 'polite');
      } else if (type === 'success') {
        feedbackPanelElement.className = `${baseClasses} border-emerald-200 bg-emerald-50`;
        feedbackPanelElement.setAttribute('role', 'status');
        feedbackPanelElement.setAttribute('aria-live', 'polite');
      } else {
        feedbackPanelElement.className = `${baseClasses} border-destructive/30 bg-destructive/10`;
        feedbackPanelElement.setAttribute('role', 'alert');
        feedbackPanelElement.setAttribute('aria-live', 'assertive');
      }
      feedbackElement.textContent = text;
    }

    rsvpButtons.forEach(button => {
      button.addEventListener('click', async (e) => {
        const target = e.currentTarget as HTMLButtonElement;
        const status = target.dataset.status;
        const eventId = target.dataset.eventId;

        if (!status || !eventId) return;

        // Disable all buttons during submission
        rsvpButtons.forEach(btn => {
          const buttonElement = btn as HTMLButtonElement;
          if (!buttonElement.dataset.originalText) {
            buttonElement.dataset.originalText = buttonElement.textContent || '';
          }
          buttonElement.disabled = true;
          buttonElement.setAttribute('aria-busy', 'true');
        });
        target.textContent = 'Saving...';
        setFeedback('Saving RSVP...', 'loading');

        try {
          const response = await fetch('/api/rsvp', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              eventId: parseInt(eventId),
              status,
            }),
          });

          if (!response.ok) {
            throw new Error('Failed to update RSVP');
          }

          setFeedback('RSVP updated successfully. Refreshing...', 'success');

          // Reload page after short delay to show updated counts
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } catch {
          setFeedback('Failed to update RSVP. Please try again.', 'error');

          // Re-enable buttons on error
          rsvpButtons.forEach(btn => {
            const buttonElement = btn as HTMLButtonElement;
            buttonElement.disabled = false;
            buttonElement.removeAttribute('aria-busy');
            if (buttonElement.dataset.originalText) {
              buttonElement.textContent = buttonElement.dataset.originalText;
            }
          });
        }
      });
    });
  });
</script>
