---
import { db, Users, Events, Rsvps, eq } from 'astro:db';
import Layout from '../../layouts/Layout.astro';
import EventRsvpControls from '@/components/EventRsvpControls';
import { buttonVariants } from '@/components/ui/button';
import { Separator } from '@/components/ui/separator';
import { CalendarDays, Clock3, MapPin } from 'lucide-react';

const { id } = Astro.params;
const { userId } = Astro.locals.auth();

// Fetch event
const event = await db
  .select()
  .from(Events)
  .where(eq(Events.id, Number(id)))
  .get();

// Return 404 if event not found
if (!event) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

// Fetch all RSVPs with user data in one joined query
const rsvpsWithUsers = await db
  .select({
    id: Rsvps.id,
    userId: Rsvps.userId,
    eventId: Rsvps.eventId,
    status: Rsvps.status,
    createdAt: Rsvps.createdAt,
    updatedAt: Rsvps.updatedAt,
    user: {
      id: Users.id,
      clerkUserId: Users.clerkUserId,
      email: Users.email,
      name: Users.name,
      createdAt: Users.createdAt,
    },
  })
  .from(Rsvps)
  .leftJoin(Users, eq(Rsvps.userId, Users.id))
  .where(eq(Rsvps.eventId, event.id))
  .all();

// Get current user's local database ID
const currentUser = userId
  ? await db.select().from(Users).where(eq(Users.clerkUserId, userId)).get()
  : null;

// Find current user's RSVP
const _currentUserRsvp = rsvpsWithUsers.find(
  (r) => r.userId === currentUser?.id,
);
const _initialRsvpStatus =
  _currentUserRsvp?.status === 'going' ||
  _currentUserRsvp?.status === 'maybe' ||
  _currentUserRsvp?.status === 'not_going'
    ? _currentUserRsvp.status
    : null;

// Calculate RSVP counts
const _goingRsvps = rsvpsWithUsers.filter((r) => r.status === 'going');
const _maybeRsvps = rsvpsWithUsers.filter((r) => r.status === 'maybe');
const _notGoingRsvps = rsvpsWithUsers.filter((r) => r.status === 'not_going');

// Calculate no response users
const totalUsers = await db.select().from(Users).all();
const rsvpedUserIds = new Set(rsvpsWithUsers.map((r) => r.userId));
const noResponseUsers = totalUsers.filter((user) => !rsvpedUserIds.has(user.id));
const _noResponseCount = noResponseUsers.length;

function _formatEventDate(date: Date): string {
  return new Intl.DateTimeFormat('no-NO', {
    timeZone: 'Europe/Oslo',
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(new Date(date));
}

function _formatEventTime(date: Date): string {
  return new Intl.DateTimeFormat('no-NO', {
    timeZone: 'Europe/Oslo',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  }).format(new Date(date));
}

function _getInitials(name: string | null | undefined): string {
  if (!name) return '??';
  const parts = name.trim().split(/\s+/).slice(0, 2);
  return parts.map((part) => part.charAt(0).toUpperCase()).join('');
}

// Check if event is upcoming (not past)
const now = new Date();
const _isUpcoming = new Date(event.dateTime) >= now;
---

<Layout
  title={`${event.title} - Torsdagskos`}
  description={`Se detaljer og svaralternativer for ${event.title} på ${event.location}.`}
>
  <section class="mx-auto mt-6 w-full max-w-5xl pb-8 sm:mt-10" data-test-id="event-detail-shell">
    <div class="mb-6">
      <a href="/" class:list={[buttonVariants({ variant: 'ghost' }), 'pl-0 no-underline']}>&larr; Tilbake til arrangementer</a>
    </div>

    <div class="mb-6 space-y-4">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
          <div class="space-y-2">
            <h1 class="m-0 text-3xl text-(--color-accent-dark) sm:text-4xl">{event.title}</h1>
            <p class="m-0 max-w-3xl whitespace-pre-wrap text-sm leading-relaxed text-foreground sm:text-base">
              {event.description || 'Ingen beskrivelse oppgitt.'}
            </p>
          </div>

          {_isUpcoming && (
            <a
              href={`/events/${event.id}/edit`}
              class:list={[buttonVariants({ variant: 'outline', size: 'default' }), 'min-h-11 min-w-11 shrink-0 no-underline']}
            >
              Rediger arrangement
            </a>
          )}
        </div>

        <div class="grid grid-cols-1 gap-3 sm:grid-cols-3">
          <article class="rounded-lg border border-primary/30 bg-primary/5 px-4 py-3">
            <p class="m-0 flex items-center gap-1.5 text-[0.7rem] font-semibold uppercase tracking-[0.16em] text-muted-foreground">
              <CalendarDays className="h-3.5 w-3.5" aria-hidden="true" />
              Dato
            </p>
            <p class="mt-1 mb-0 text-sm font-medium text-foreground">{_formatEventDate(event.dateTime)}</p>
          </article>
          <article class="rounded-lg border border-primary/30 bg-primary/5 px-4 py-3">
            <p class="m-0 flex items-center gap-1.5 text-[0.7rem] font-semibold uppercase tracking-[0.16em] text-muted-foreground">
              <Clock3 className="h-3.5 w-3.5" aria-hidden="true" />
              Tid
            </p>
            <p class="mt-1 mb-0 text-sm font-medium text-foreground">{_formatEventTime(event.dateTime)}</p>
          </article>
          <article class="rounded-lg border border-primary/30 bg-primary/5 px-4 py-3">
            <p class="m-0 flex items-center gap-1.5 text-[0.7rem] font-semibold uppercase tracking-[0.16em] text-muted-foreground">
              <MapPin className="h-3.5 w-3.5" aria-hidden="true" />
              Sted
            </p>
            <p class="mt-1 mb-0 text-sm font-medium text-foreground">{event.location}</p>
            {event.mapLink && (
              <a
                href={event.mapLink}
                target="_blank"
                rel="noopener noreferrer"
                class:list={[buttonVariants({ variant: 'ghost', size: 'sm' }), 'mt-1.5 -ml-3 no-underline']}
              >
                Åpne i kart &rarr;
              </a>
            )}
          </article>
        </div>
    </div>
    <Separator className="my-6" />

    <h2 class="mb-3 mt-0 text-lg text-(--color-accent-dark) sm:text-xl">RSVP</h2>
    <section class="space-y-5">
      <EventRsvpControls
        client:load
        eventId={event.id}
        isUpcoming={_isUpcoming}
        initialStatus={_initialRsvpStatus}
        initialCounts={{
          going: _goingRsvps.length,
          maybe: _maybeRsvps.length,
          notGoing: _notGoingRsvps.length,
          noResponse: _noResponseCount,
        }}
      />

      {!_isUpcoming && (
        <div data-test-id="past-event-notice" class="rounded-md border bg-muted/60 p-4 text-center italic text-muted-foreground">
          Dette arrangementet er over. Svar er ikke lenger tilgjengelig.
        </div>
      )}
    </section>
    <Separator className="my-6" />

    <div class="mb-3 flex items-center justify-between">
      <h2 class="m-0 text-lg text-(--color-accent-dark) sm:text-xl">Inviterte</h2>
      <span class="text-xs uppercase tracking-[0.16em] text-muted-foreground">Totalt {totalUsers.length}</span>
    </div>
    <div data-slot="card" class="bg-card text-card-foreground rounded-xl border shadow-sm">
      <div data-slot="card-content" class="space-y-5 px-6 py-6 sm:px-8">
        <section>
          <h3 class="m-0 text-sm font-semibold uppercase tracking-[0.14em] text-emerald-700">Kommer ({_goingRsvps.length})</h3>
          <ul class="mt-2 list-none divide-y p-0">
            {_goingRsvps.length === 0 && <li class="px-4 py-3 text-sm text-muted-foreground">Ingen svar i denne gruppen.</li>}
            {_goingRsvps.map((rsvp) => (
              <li class="flex items-center justify-between gap-3 px-4 py-3">
                <div class="flex items-center gap-3">
                  <span class="inline-flex h-8 w-8 items-center justify-center rounded-full border bg-primary/5 text-xs font-semibold text-(--color-accent-dark)">
                    {_getInitials(rsvp.user?.name)}
                  </span>
                  <span class="text-sm text-foreground">{rsvp.user?.name || 'Ukjent bruker'}</span>
                </div>
                <span class="inline-flex items-center rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-medium text-emerald-700">
                  Kommer
                </span>
              </li>
            ))}
          </ul>
        </section>

        <section>
          <h3 class="m-0 text-sm font-semibold uppercase tracking-[0.14em] text-amber-700">Kanskje ({_maybeRsvps.length})</h3>
          <ul class="mt-2 list-none divide-y p-0">
            {_maybeRsvps.length === 0 && <li class="px-4 py-3 text-sm text-muted-foreground">Ingen svar i denne gruppen.</li>}
            {_maybeRsvps.map((rsvp) => (
              <li class="flex items-center justify-between gap-3 px-4 py-3">
                <div class="flex items-center gap-3">
                  <span class="inline-flex h-8 w-8 items-center justify-center rounded-full border bg-primary/5 text-xs font-semibold text-(--color-accent-dark)">
                    {_getInitials(rsvp.user?.name)}
                  </span>
                  <span class="text-sm text-foreground">{rsvp.user?.name || 'Ukjent bruker'}</span>
                </div>
                <span class="inline-flex items-center rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-medium text-amber-700">
                  Kanskje
                </span>
              </li>
            ))}
          </ul>
        </section>

        <section>
          <h3 class="m-0 text-sm font-semibold uppercase tracking-[0.14em] text-rose-700">Kommer ikke ({_notGoingRsvps.length})</h3>
          <ul class="mt-2 list-none divide-y p-0">
            {_notGoingRsvps.length === 0 && <li class="px-4 py-3 text-sm text-muted-foreground">Ingen svar i denne gruppen.</li>}
            {_notGoingRsvps.map((rsvp) => (
              <li class="flex items-center justify-between gap-3 px-4 py-3">
                <div class="flex items-center gap-3">
                  <span class="inline-flex h-8 w-8 items-center justify-center rounded-full border bg-primary/5 text-xs font-semibold text-(--color-accent-dark)">
                    {_getInitials(rsvp.user?.name)}
                  </span>
                  <span class="text-sm text-foreground">{rsvp.user?.name || 'Ukjent bruker'}</span>
                </div>
                <span class="inline-flex items-center rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-xs font-medium text-rose-700">
                  Kommer ikke
                </span>
              </li>
            ))}
          </ul>
        </section>

        <section>
          <h3 class="m-0 text-sm font-semibold uppercase tracking-[0.14em] text-muted-foreground">Ingen respons ({_noResponseCount})</h3>
          <ul class="mt-2 list-none divide-y p-0">
            {noResponseUsers.length === 0 && <li class="px-4 py-3 text-sm text-muted-foreground">Alle inviterte har svart.</li>}
            {noResponseUsers.map((user) => (
              <li class="flex items-center justify-between gap-3 px-4 py-3">
                <div class="flex items-center gap-3">
                  <span class="inline-flex h-8 w-8 items-center justify-center rounded-full border bg-primary/5 text-xs font-semibold text-(--color-accent-dark)">
                    {_getInitials(user.name)}
                  </span>
                  <span class="text-sm text-foreground">{user.name || 'Ukjent bruker'}</span>
                </div>
                <span class="inline-flex items-center rounded-full border bg-muted px-3 py-1 text-xs font-medium text-muted-foreground">
                  Ikke svart
                </span>
              </li>
            ))}
          </ul>
        </section>
      </div>
    </div>
  </section>
</Layout>
