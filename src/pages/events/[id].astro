---
import Layout from '../../layouts/Layout.astro';
import { db, Users, Events, Rsvps, eq } from 'astro:db';

const { id } = Astro.params;
const { userId } = Astro.locals.auth();

// Fetch event
const event = await db
  .select()
  .from(Events)
  .where(eq(Events.id, Number(id)))
  .get();

// Return 404 if event not found
if (!event) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

// Fetch all RSVPs with user information
const rsvps = await db
  .select()
  .from(Rsvps)
  .where(eq(Rsvps.eventId, event.id))
  .all();

// Get user details for all RSVPs
const rsvpsWithUsers = await Promise.all(
  rsvps.map(async (rsvp) => {
    const user = await db
      .select()
      .from(Users)
      .where(eq(Users.id, rsvp.userId))
      .get();
    return { ...rsvp, user };
  })
);

// Get current user's local database ID
const currentUser = await db
  .select()
  .from(Users)
  .where(eq(Users.clerkUserId, userId!))
  .get();

// Find current user's RSVP
const currentUserRsvp = rsvpsWithUsers.find(r => r.userId === currentUser?.id);

// Calculate RSVP counts
const goingRsvps = rsvpsWithUsers.filter(r => r.status === 'going');
const maybeRsvps = rsvpsWithUsers.filter(r => r.status === 'maybe');
const notGoingRsvps = rsvpsWithUsers.filter(r => r.status === 'not_going');

// Calculate no response count (total users - users who RSVPd)
const totalUsers = await db.select().from(Users).all();
const noResponseCount = totalUsers.length - rsvpsWithUsers.length;

// Format date in Europe/Oslo timezone
function formatEventDate(date: Date): string {
  return new Intl.DateTimeFormat('no-NO', {
    timeZone: 'Europe/Oslo',
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  }).format(new Date(date));
}

// Check if event is upcoming (not past)
const now = new Date();
const isUpcoming = new Date(event.dateTime) >= now;
---

<Layout title={event.title}>
  <div class="mx-auto max-w-225 p-4 sm:p-6">
    <div class="mb-8">
      <a href="/" class="mb-4 inline-block text-[0.95rem] text-(--color-accent) no-underline transition-colors duration-200 hover:text-(--color-accent-dark)">&larr; Back to Events</a>
      <h1 class="mb-3 mt-0 text-[1.75rem] text-(--color-accent-dark) sm:text-[2.5rem]">{event.title}</h1>
      <p class="m-0 text-[0.95rem] text-(--color-text-secondary) sm:text-[1.1rem]">{formatEventDate(event.dateTime)}</p>
      {isUpcoming && (
        <div class="mt-4">
          <a href={`/events/${event.id}/edit`} class="touch-target inline-flex items-center rounded-md border-2 border-(--color-accent) bg-(--color-accent) px-4 py-2 font-medium text-white no-underline transition-all duration-200 hover:-translate-y-px hover:border-(--color-accent-dark) hover:bg-(--color-accent-dark)">Edit Event</a>
        </div>
      )}
    </div>

    <div class="grid grid-cols-1 gap-8 md:grid-cols-2">
      <div class="rounded-lg border border-(--color-border) bg-white p-6">
        <div class="mb-6 last:mb-0">
          <h2 class="mb-3 mt-0 text-xl text-(--color-accent-dark)">Description</h2>
          <p class="m-0 whitespace-pre-wrap leading-relaxed text-(--color-text-primary)">{event.description}</p>
        </div>

        <div class="mb-6 last:mb-0">
          <h2 class="mb-3 mt-0 text-xl text-(--color-accent-dark)">Location</h2>
          <p class="mb-3 mt-0 text-(--color-text-primary)">{event.location}</p>
          {event.mapLink && (
            <a href={event.mapLink} target="_blank" rel="noopener noreferrer" class="inline-block text-[0.95rem] text-(--color-accent) no-underline transition-colors duration-200 hover:text-(--color-accent-dark)">
              Open in Maps &rarr;
            </a>
          )}
        </div>
      </div>

      <div class="rounded-lg border border-(--color-border) bg-white p-6">
        <h2 class="mb-3 mt-0 text-xl text-(--color-accent-dark)">RSVPs</h2>

        {isUpcoming && (
          <div class="mb-6 flex flex-wrap gap-3">
            <button
              class={`min-w-25 flex-1 rounded-md border-2 border-(--color-border) bg-white px-4 py-3 text-base font-medium text-(--color-text-primary) transition-all duration-200 hover:-translate-y-px hover:border-(--color-accent) disabled:cursor-not-allowed disabled:opacity-50 ${currentUserRsvp?.status === 'going' ? 'border-(--color-success) bg-[#e8f5e9] text-(--color-success)' : ''}`}
              data-rsvp-button="true"
              data-status="going"
              data-active={currentUserRsvp?.status === 'going' ? 'true' : 'false'}
              data-event-id={event.id}
            >
              Going
            </button>
            <button
              class={`min-w-25 flex-1 rounded-md border-2 border-(--color-border) bg-white px-4 py-3 text-base font-medium text-(--color-text-primary) transition-all duration-200 hover:-translate-y-px hover:border-(--color-accent) disabled:cursor-not-allowed disabled:opacity-50 ${currentUserRsvp?.status === 'maybe' ? 'border-(--color-warning) bg-[#fff3e0] text-(--color-warning)' : ''}`}
              data-rsvp-button="true"
              data-status="maybe"
              data-active={currentUserRsvp?.status === 'maybe' ? 'true' : 'false'}
              data-event-id={event.id}
            >
              Maybe
            </button>
            <button
              class={`min-w-25 flex-1 rounded-md border-2 border-(--color-border) bg-white px-4 py-3 text-base font-medium text-(--color-text-primary) transition-all duration-200 hover:-translate-y-px hover:border-(--color-accent) disabled:cursor-not-allowed disabled:opacity-50 ${currentUserRsvp?.status === 'not_going' ? 'border-(--color-error) bg-[#ffebee] text-(--color-error)' : ''}`}
              data-rsvp-button="true"
              data-status="not_going"
              data-active={currentUserRsvp?.status === 'not_going' ? 'true' : 'false'}
              data-event-id={event.id}
            >
              Not Going
            </button>
          </div>
        )}

        {!isUpcoming && (
          <div data-test-id="past-event-notice" class="mb-6 rounded-md bg-(--color-border) p-4 text-center italic text-(--color-text-muted)">
            This event has passed. RSVPs are no longer available.
          </div>
        )}

        {currentUserRsvp && (
          <div data-test-id="current-user-rsvp" class="mb-6 flex items-center gap-3 rounded-md border-2 border-(--color-accent) bg-(--color-primary-500) p-4">
            <strong>Your status:</strong>
            <span class={`rounded-full px-4 py-2 text-[0.9rem] font-medium ${
              currentUserRsvp.status === 'going'
                ? 'bg-[#e8f5e9] text-(--color-success)'
                : currentUserRsvp.status === 'maybe'
                  ? 'bg-[#fff3e0] text-(--color-warning)'
                  : 'bg-[#ffebee] text-(--color-error)'
            }`}>
              {currentUserRsvp.status === 'going' && 'Going'}
              {currentUserRsvp.status === 'maybe' && 'Maybe'}
              {currentUserRsvp.status === 'not_going' && 'Not Going'}
            </span>
          </div>
        )}

        {!currentUserRsvp && (
          <div data-test-id="current-user-rsvp" class="mb-6 flex items-center gap-3 rounded-md border-2 border-(--color-border) bg-white p-4">
            <strong>Your status:</strong>
            <span class="rounded-full bg-(--color-border) px-4 py-2 text-[0.9rem] font-medium text-(--color-text-muted)">No Response</span>
          </div>
        )}

        <div data-test-id="rsvp-counts" class="mb-6 grid grid-cols-2 gap-4 sm:grid-cols-4">
          <div data-test-id="rsvp-count-item" data-rsvp-type="going" class="rounded-md bg-(--color-primary-500) p-4 text-center">
            <span data-test-id="rsvp-count-value" class="mb-2 block text-3xl font-semibold text-(--color-accent-dark)">{goingRsvps.length}</span>
            <span class="label block text-[0.85rem] uppercase tracking-[0.5px] text-(--color-text-muted)">Going</span>
          </div>
          <div data-test-id="rsvp-count-item" data-rsvp-type="maybe" class="rounded-md bg-(--color-primary-500) p-4 text-center">
            <span data-test-id="rsvp-count-value" class="mb-2 block text-3xl font-semibold text-(--color-accent-dark)">{maybeRsvps.length}</span>
            <span class="label block text-[0.85rem] uppercase tracking-[0.5px] text-(--color-text-muted)">Maybe</span>
          </div>
          <div data-test-id="rsvp-count-item" data-rsvp-type="not_going" class="rounded-md bg-(--color-primary-500) p-4 text-center">
            <span data-test-id="rsvp-count-value" class="mb-2 block text-3xl font-semibold text-(--color-accent-dark)">{notGoingRsvps.length}</span>
            <span class="label block text-[0.85rem] uppercase tracking-[0.5px] text-(--color-text-muted)">Not Going</span>
          </div>
          <div data-test-id="rsvp-count-item" data-rsvp-type="no_response" class="rounded-md bg-(--color-primary-500) p-4 text-center">
            <span data-test-id="rsvp-count-value" class="mb-2 block text-3xl font-semibold text-(--color-accent-dark)">{noResponseCount}</span>
            <span class="label block text-[0.85rem] uppercase tracking-[0.5px] text-(--color-text-muted)">No Response</span>
          </div>
        </div>

        {goingRsvps.length > 0 && (
          <div class="mb-6 last:mb-0">
            <h3 class="mb-3 mt-0 text-base font-semibold text-(--color-text-secondary)">Going ({goingRsvps.length})</h3>
            <ul class="m-0 list-none p-0">
              {goingRsvps.map(rsvp => (
                <li class="mb-2 rounded-sm bg-(--color-primary-500) px-3 py-2 text-(--color-text-primary) last:mb-0">{rsvp.user?.name}</li>
              ))}
            </ul>
          </div>
        )}

        {maybeRsvps.length > 0 && (
          <div class="mb-6 last:mb-0">
            <h3 class="mb-3 mt-0 text-base font-semibold text-(--color-text-secondary)">Maybe ({maybeRsvps.length})</h3>
            <ul class="m-0 list-none p-0">
              {maybeRsvps.map(rsvp => (
                <li class="mb-2 rounded-sm bg-(--color-primary-500) px-3 py-2 text-(--color-text-primary) last:mb-0">{rsvp.user?.name}</li>
              ))}
            </ul>
          </div>
        )}

        {notGoingRsvps.length > 0 && (
          <div class="mb-6 last:mb-0">
            <h3 class="mb-3 mt-0 text-base font-semibold text-(--color-text-secondary)">Not Going ({notGoingRsvps.length})</h3>
            <ul class="m-0 list-none p-0">
              {notGoingRsvps.map(rsvp => (
                <li class="mb-2 rounded-sm bg-(--color-primary-500) px-3 py-2 text-(--color-text-primary) last:mb-0">{rsvp.user?.name}</li>
              ))}
            </ul>
          </div>
        )}
      </div>
    </div>
  </div>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const rsvpButtons = document.querySelectorAll('[data-rsvp-button]');

    rsvpButtons.forEach(button => {
      button.addEventListener('click', async (e) => {
        const target = e.currentTarget as HTMLButtonElement;
        const status = target.dataset.status;
        const eventId = target.dataset.eventId;

        if (!status || !eventId) return;

        // Disable all buttons during submission
        rsvpButtons.forEach(btn => (btn as HTMLButtonElement).disabled = true);

        try {
          const response = await fetch('/api/rsvp', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              eventId: parseInt(eventId),
              status,
            }),
          });

          if (!response.ok) {
            throw new Error('Failed to update RSVP');
          }

          // Show success message
          const successMessage = document.createElement('div');
          successMessage.className = 'toast-message fixed z-[1000] rounded-md bg-(--color-success) px-6 py-4 text-white shadow-lg';
          successMessage.setAttribute('data-test-id', 'rsvp-success-message');
          successMessage.textContent = 'RSVP updated successfully!';
          document.body.appendChild(successMessage);

          // Reload page after short delay to show updated counts
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } catch (error) {
          console.error('Error updating RSVP:', error);
          alert('Failed to update RSVP. Please try again.');

          // Re-enable buttons on error
          rsvpButtons.forEach(btn => (btn as HTMLButtonElement).disabled = false);
        }
      });
    });
  });
</script>
