---
import Layout from '../../layouts/Layout.astro';
import { db, Users, Events, Rsvps, eq, inArray } from 'astro:db';
import { buttonVariants } from '@/components/ui/button';
import { Separator } from '@/components/ui/separator';
import {
  CalendarDays,
  Check,
  CircleHelp,
  Clock3,
  MapPin,
  Minus,
  X,
} from 'lucide-react';

const { id } = Astro.params;
const { userId } = Astro.locals.auth();

// Fetch event
const event = await db
  .select()
  .from(Events)
  .where(eq(Events.id, Number(id)))
  .get();

// Return 404 if event not found
if (!event) {
  return new Response(null, { status: 404, statusText: 'Not Found' });
}

// Fetch all RSVPs with user information
const rsvps = await db
  .select()
  .from(Rsvps)
  .where(eq(Rsvps.eventId, event.id))
  .all();

const rsvpUserIds = [...new Set(rsvps.map((rsvp) => rsvp.userId))];
const rsvpUsers =
  rsvpUserIds.length > 0
    ? await db.select().from(Users).where(inArray(Users.id, rsvpUserIds)).all()
    : [];
const userMap = new Map(rsvpUsers.map((user) => [user.id, user]));

const rsvpsWithUsers = rsvps.map((rsvp) => ({
  ...rsvp,
  user: userMap.get(rsvp.userId),
}));

// Get current user's local database ID
const currentUser = await db
  .select()
  .from(Users)
  .where(eq(Users.clerkUserId, userId!))
  .get();

// Find current user's RSVP
const currentUserRsvp = rsvpsWithUsers.find(
  (r) => r.userId === currentUser?.id,
);

// Calculate RSVP counts
const goingRsvps = rsvpsWithUsers.filter((r) => r.status === 'going');
const maybeRsvps = rsvpsWithUsers.filter((r) => r.status === 'maybe');
const notGoingRsvps = rsvpsWithUsers.filter((r) => r.status === 'not_going');

// Calculate no response users
const totalUsers = await db.select().from(Users).all();
const rsvpedUserIds = new Set(rsvpsWithUsers.map((r) => r.userId));
const noResponseUsers = totalUsers.filter((user) => !rsvpedUserIds.has(user.id));
const noResponseCount = noResponseUsers.length;

function formatEventDate(date: Date): string {
  return new Intl.DateTimeFormat('no-NO', {
    timeZone: 'Europe/Oslo',
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  }).format(new Date(date));
}

function formatEventTime(date: Date): string {
  return new Intl.DateTimeFormat('no-NO', {
    timeZone: 'Europe/Oslo',
    hour: '2-digit',
    minute: '2-digit',
    hour12: false,
  }).format(new Date(date));
}

function getInitials(name: string | null | undefined): string {
  if (!name) return '??';
  const parts = name.trim().split(/\s+/).slice(0, 2);
  return parts.map((part) => part.charAt(0).toUpperCase()).join('');
}

// Check if event is upcoming (not past)
const now = new Date();
const isUpcoming = new Date(event.dateTime) >= now;
---

<Layout
  title={`${event.title} - Torsdagskos`}
  description={`Se detaljer og svaralternativer for ${event.title} på ${event.location}.`}
>
  <section class="mx-auto mt-6 w-full max-w-5xl pb-8 sm:mt-10" data-test-id="event-detail-shell">
    <div class="mb-6">
      <a href="/" class:list={[buttonVariants({ variant: 'ghost' }), 'pl-0 no-underline']}>&larr; Tilbake til arrangementer</a>
    </div>

    <div class="mb-6 space-y-4">
        <div class="flex flex-col gap-4 sm:flex-row sm:items-start sm:justify-between">
          <div class="space-y-2">
            <h1 class="m-0 text-3xl text-(--color-accent-dark) sm:text-4xl">{event.title}</h1>
            <p class="m-0 max-w-3xl whitespace-pre-wrap text-sm leading-relaxed text-foreground sm:text-base">
              {event.description || 'Ingen beskrivelse oppgitt.'}
            </p>
          </div>

          {isUpcoming && (
            <a
              href={`/events/${event.id}/edit`}
              class:list={[buttonVariants({ variant: 'outline', size: 'default' }), 'min-h-11 min-w-11 shrink-0 no-underline']}
            >
              Rediger arrangement
            </a>
          )}
        </div>

        <div class="grid grid-cols-1 gap-3 sm:grid-cols-3">
          <article class="rounded-lg border border-primary/30 bg-primary/5 px-4 py-3">
            <p class="m-0 flex items-center gap-1.5 text-[0.7rem] font-semibold uppercase tracking-[0.16em] text-muted-foreground">
              <CalendarDays className="h-3.5 w-3.5" aria-hidden="true" />
              Dato
            </p>
            <p class="mt-1 mb-0 text-sm font-medium text-foreground">{formatEventDate(event.dateTime)}</p>
          </article>
          <article class="rounded-lg border border-primary/30 bg-primary/5 px-4 py-3">
            <p class="m-0 flex items-center gap-1.5 text-[0.7rem] font-semibold uppercase tracking-[0.16em] text-muted-foreground">
              <Clock3 className="h-3.5 w-3.5" aria-hidden="true" />
              Tid
            </p>
            <p class="mt-1 mb-0 text-sm font-medium text-foreground">{formatEventTime(event.dateTime)}</p>
          </article>
          <article class="rounded-lg border border-primary/30 bg-primary/5 px-4 py-3">
            <p class="m-0 flex items-center gap-1.5 text-[0.7rem] font-semibold uppercase tracking-[0.16em] text-muted-foreground">
              <MapPin className="h-3.5 w-3.5" aria-hidden="true" />
              Sted
            </p>
            <p class="mt-1 mb-0 text-sm font-medium text-foreground">{event.location}</p>
            {event.mapLink && (
              <a
                href={event.mapLink}
                target="_blank"
                rel="noopener noreferrer"
                class:list={[buttonVariants({ variant: 'ghost', size: 'sm' }), 'mt-1.5 -ml-3 no-underline']}
              >
                Åpne i kart &rarr;
              </a>
            )}
          </article>
        </div>
    </div>
    <Separator className="my-6" />

    <h2 class="mb-3 mt-0 text-lg text-(--color-accent-dark) sm:text-xl">RSVP</h2>
    <section class="space-y-5">
        <section data-test-id="current-user-rsvp" class="space-y-4 rounded-xl border border-primary/30 bg-primary/5 px-4 py-4">
          <div class="flex flex-wrap items-center justify-between gap-3">
            <div>
              <p class="m-0 text-[0.7rem] font-semibold uppercase tracking-[0.16em] text-muted-foreground">Ditt svar</p>
              <p class="mt-1 mb-0 text-sm font-medium text-foreground">Velg status:</p>
            </div>
          </div>

          {isUpcoming && (
            <div class="grid grid-cols-1 gap-2.5 sm:grid-cols-3">
              <button
                class:list={[
                  buttonVariants({ variant: 'outline', size: 'default' }),
                  'min-h-11 min-w-11 cursor-pointer px-3 py-2.5 text-sm sm:text-base',
                  currentUserRsvp?.status === 'going' && 'border-emerald-300 bg-emerald-50 text-emerald-700 hover:bg-emerald-100'
                ]}
                data-slot="button"
                data-rsvp-button="true"
                data-status="going"
                data-active={currentUserRsvp?.status === 'going' ? 'true' : 'false'}
                data-event-id={event.id}
                aria-label="Kommer"
              >
                <Check className="h-4 w-4" aria-hidden="true" />
                Kommer
              </button>
              <button
                class:list={[
                  buttonVariants({ variant: 'outline', size: 'default' }),
                  'min-h-11 min-w-11 cursor-pointer px-3 py-2.5 text-sm sm:text-base',
                  currentUserRsvp?.status === 'maybe' && 'border-amber-300 bg-amber-50 text-amber-700 hover:bg-amber-100'
                ]}
                data-slot="button"
                data-rsvp-button="true"
                data-status="maybe"
                data-active={currentUserRsvp?.status === 'maybe' ? 'true' : 'false'}
                data-event-id={event.id}
                aria-label="Kanskje"
              >
                <CircleHelp className="h-4 w-4" aria-hidden="true" />
                Kanskje
              </button>
              <button
                class:list={[
                  buttonVariants({ variant: 'outline', size: 'default' }),
                  'min-h-11 min-w-11 cursor-pointer px-3 py-2.5 text-sm sm:text-base',
                  currentUserRsvp?.status === 'not_going' && 'border-rose-300 bg-rose-50 text-rose-700 hover:bg-rose-100'
                ]}
                data-slot="button"
                data-rsvp-button="true"
                data-status="not_going"
                data-active={currentUserRsvp?.status === 'not_going' ? 'true' : 'false'}
                data-event-id={event.id}
                aria-label="Kommer ikke"
              >
                <X className="h-4 w-4" aria-hidden="true" />
                Kommer ikke
              </button>
            </div>
          )}
        </section>

        <div
          id="rsvp-feedback-panel"
          data-test-id="rsvp-feedback-panel"
          class="hidden rounded-md border px-4 py-3"
          role="status"
          aria-live="polite"
        >
          <p id="rsvp-feedback" class="m-0 text-sm text-foreground"></p>
        </div>

        {!isUpcoming && (
          <div data-test-id="past-event-notice" class="rounded-md border bg-muted/60 p-4 text-center italic text-muted-foreground">
            Dette arrangementet er over. Svar er ikke lenger tilgjengelig.
          </div>
        )}

        <div data-test-id="rsvp-counts" class="grid grid-cols-2 gap-3 sm:grid-cols-4">
          <div data-test-id="rsvp-count-item" data-rsvp-type="going" class="rounded-lg border border-primary/30 bg-primary/5 p-3 text-center">
            <span class="mb-2 inline-flex h-8 w-8 items-center justify-center rounded-full border border-emerald-200 bg-emerald-50 text-emerald-700">
              <Check className="h-4 w-4" aria-hidden="true" />
            </span>
            <span data-test-id="rsvp-count-value" class="mb-1 block text-2xl font-semibold text-(--color-accent-dark)">{goingRsvps.length}</span>
            <span class="block text-[0.72rem] uppercase tracking-wide text-muted-foreground">Kommer</span>
          </div>
          <div data-test-id="rsvp-count-item" data-rsvp-type="maybe" class="rounded-lg border border-primary/30 bg-primary/5 p-3 text-center">
            <span class="mb-2 inline-flex h-8 w-8 items-center justify-center rounded-full border border-amber-200 bg-amber-50 text-amber-700">
              <CircleHelp className="h-4 w-4" aria-hidden="true" />
            </span>
            <span data-test-id="rsvp-count-value" class="mb-1 block text-2xl font-semibold text-(--color-accent-dark)">{maybeRsvps.length}</span>
            <span class="block text-[0.72rem] uppercase tracking-wide text-muted-foreground">Kanskje</span>
          </div>
          <div data-test-id="rsvp-count-item" data-rsvp-type="not_going" class="rounded-lg border border-primary/30 bg-primary/5 p-3 text-center">
            <span class="mb-2 inline-flex h-8 w-8 items-center justify-center rounded-full border border-rose-200 bg-rose-50 text-rose-700">
              <X className="h-4 w-4" aria-hidden="true" />
            </span>
            <span data-test-id="rsvp-count-value" class="mb-1 block text-2xl font-semibold text-(--color-accent-dark)">{notGoingRsvps.length}</span>
            <span class="block text-[0.72rem] uppercase tracking-wide text-muted-foreground">Kommer ikke</span>
          </div>
          <div data-test-id="rsvp-count-item" data-rsvp-type="no_response" class="rounded-lg border border-primary/30 bg-primary/5 p-3 text-center">
            <span class="mb-2 inline-flex h-8 w-8 items-center justify-center rounded-full border bg-muted text-muted-foreground">
              <Minus className="h-4 w-4" aria-hidden="true" />
            </span>
            <span data-test-id="rsvp-count-value" class="mb-1 block text-2xl font-semibold text-(--color-accent-dark)">{noResponseCount}</span>
            <span class="block text-[0.72rem] uppercase tracking-wide text-muted-foreground">Ingen respons</span>
          </div>
        </div>
    </section>
    <Separator className="my-6" />

    <div class="mb-3 flex items-center justify-between">
      <h2 class="m-0 text-lg text-(--color-accent-dark) sm:text-xl">Inviterte</h2>
      <span class="text-xs uppercase tracking-[0.16em] text-muted-foreground">Totalt {totalUsers.length}</span>
    </div>
    <div data-slot="card" class="bg-card text-card-foreground rounded-xl border shadow-sm">
      <div data-slot="card-content" class="space-y-5 px-6 py-6 sm:px-8">
        <section>
          <h3 class="m-0 text-sm font-semibold uppercase tracking-[0.14em] text-emerald-700">Kommer ({goingRsvps.length})</h3>
          <ul class="mt-2 list-none divide-y p-0">
            {goingRsvps.length === 0 && <li class="px-4 py-3 text-sm text-muted-foreground">Ingen svar i denne gruppen.</li>}
            {goingRsvps.map((rsvp) => (
              <li class="flex items-center justify-between gap-3 px-4 py-3">
                <div class="flex items-center gap-3">
                  <span class="inline-flex h-8 w-8 items-center justify-center rounded-full border bg-primary/5 text-xs font-semibold text-(--color-accent-dark)">
                    {getInitials(rsvp.user?.name)}
                  </span>
                  <span class="text-sm text-foreground">{rsvp.user?.name || 'Ukjent bruker'}</span>
                </div>
                <span class="inline-flex items-center rounded-full border border-emerald-200 bg-emerald-50 px-3 py-1 text-xs font-medium text-emerald-700">
                  Kommer
                </span>
              </li>
            ))}
          </ul>
        </section>

        <section>
          <h3 class="m-0 text-sm font-semibold uppercase tracking-[0.14em] text-amber-700">Kanskje ({maybeRsvps.length})</h3>
          <ul class="mt-2 list-none divide-y p-0">
            {maybeRsvps.length === 0 && <li class="px-4 py-3 text-sm text-muted-foreground">Ingen svar i denne gruppen.</li>}
            {maybeRsvps.map((rsvp) => (
              <li class="flex items-center justify-between gap-3 px-4 py-3">
                <div class="flex items-center gap-3">
                  <span class="inline-flex h-8 w-8 items-center justify-center rounded-full border bg-primary/5 text-xs font-semibold text-(--color-accent-dark)">
                    {getInitials(rsvp.user?.name)}
                  </span>
                  <span class="text-sm text-foreground">{rsvp.user?.name || 'Ukjent bruker'}</span>
                </div>
                <span class="inline-flex items-center rounded-full border border-amber-200 bg-amber-50 px-3 py-1 text-xs font-medium text-amber-700">
                  Kanskje
                </span>
              </li>
            ))}
          </ul>
        </section>

        <section>
          <h3 class="m-0 text-sm font-semibold uppercase tracking-[0.14em] text-rose-700">Kommer ikke ({notGoingRsvps.length})</h3>
          <ul class="mt-2 list-none divide-y p-0">
            {notGoingRsvps.length === 0 && <li class="px-4 py-3 text-sm text-muted-foreground">Ingen svar i denne gruppen.</li>}
            {notGoingRsvps.map((rsvp) => (
              <li class="flex items-center justify-between gap-3 px-4 py-3">
                <div class="flex items-center gap-3">
                  <span class="inline-flex h-8 w-8 items-center justify-center rounded-full border bg-primary/5 text-xs font-semibold text-(--color-accent-dark)">
                    {getInitials(rsvp.user?.name)}
                  </span>
                  <span class="text-sm text-foreground">{rsvp.user?.name || 'Ukjent bruker'}</span>
                </div>
                <span class="inline-flex items-center rounded-full border border-rose-200 bg-rose-50 px-3 py-1 text-xs font-medium text-rose-700">
                  Kommer ikke
                </span>
              </li>
            ))}
          </ul>
        </section>

        <section>
          <h3 class="m-0 text-sm font-semibold uppercase tracking-[0.14em] text-muted-foreground">Ingen respons ({noResponseCount})</h3>
          <ul class="mt-2 list-none divide-y p-0">
            {noResponseUsers.length === 0 && <li class="px-4 py-3 text-sm text-muted-foreground">Alle inviterte har svart.</li>}
            {noResponseUsers.map((user) => (
              <li class="flex items-center justify-between gap-3 px-4 py-3">
                <div class="flex items-center gap-3">
                  <span class="inline-flex h-8 w-8 items-center justify-center rounded-full border bg-primary/5 text-xs font-semibold text-(--color-accent-dark)">
                    {getInitials(user.name)}
                  </span>
                  <span class="text-sm text-foreground">{user.name || 'Ukjent bruker'}</span>
                </div>
                <span class="inline-flex items-center rounded-full border bg-muted px-3 py-1 text-xs font-medium text-muted-foreground">
                  Ikke svart
                </span>
              </li>
            ))}
          </ul>
        </section>
      </div>
    </div>
  </section>
</Layout>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const rsvpButtons = document.querySelectorAll('[data-rsvp-button]');
    const feedbackPanel = document.getElementById('rsvp-feedback-panel');
    const feedback = document.getElementById('rsvp-feedback');

    if (!feedbackPanel || !feedback) {
      return;
    }
    const feedbackPanelElement = feedbackPanel as HTMLDivElement;
    const feedbackElement = feedback as HTMLParagraphElement;

    function setFeedback(text: string, type: 'idle' | 'loading' | 'success' | 'error') {
      if (type === 'idle') {
        feedbackPanelElement.className = 'hidden rounded-md border px-4 py-3';
        feedbackElement.textContent = '';
        feedbackPanelElement.setAttribute('role', 'status');
        feedbackPanelElement.setAttribute('aria-live', 'polite');
        return;
      }

      const baseClasses = 'block rounded-md border px-4 py-3';
      if (type === 'loading') {
        feedbackPanelElement.className = `${baseClasses} border-border bg-muted/50`;
        feedbackPanelElement.setAttribute('role', 'status');
        feedbackPanelElement.setAttribute('aria-live', 'polite');
      } else if (type === 'success') {
        feedbackPanelElement.className = `${baseClasses} border-emerald-200 bg-emerald-50`;
        feedbackPanelElement.setAttribute('role', 'status');
        feedbackPanelElement.setAttribute('aria-live', 'polite');
      } else {
        feedbackPanelElement.className = `${baseClasses} border-destructive/30 bg-destructive/10`;
        feedbackPanelElement.setAttribute('role', 'alert');
        feedbackPanelElement.setAttribute('aria-live', 'assertive');
      }
      feedbackElement.textContent = text;
    }

    rsvpButtons.forEach(button => {
      button.addEventListener('click', async (e) => {
        const target = e.currentTarget as HTMLButtonElement;
        const status = target.dataset.status;
        const eventId = target.dataset.eventId;

        if (!status || !eventId) return;

        // Disable all buttons during submission
        rsvpButtons.forEach(btn => {
          const buttonElement = btn as HTMLButtonElement;
          if (!buttonElement.dataset.originalText) {
            buttonElement.dataset.originalText = buttonElement.textContent || '';
          }
          buttonElement.disabled = true;
          buttonElement.setAttribute('aria-busy', 'true');
        });
        target.textContent = 'Lagrer...';
        setFeedback('Lagrer svar...', 'loading');

        try {
          const controller = new AbortController();
          const timeoutId = window.setTimeout(() => controller.abort(), 10000);
          const response = await fetch('/api/rsvp', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              eventId: parseInt(eventId),
              status,
            }),
            signal: controller.signal,
          }).finally(() => {
            window.clearTimeout(timeoutId);
          });

          if (!response.ok) {
            throw new Error('Kunne ikke oppdatere svar');
          }

          setFeedback('Svar oppdatert. Laster på nytt...', 'success');

          // Reload page after short delay to show updated counts
          setTimeout(() => {
            window.location.reload();
          }, 1000);
        } catch {
          setFeedback('Kunne ikke oppdatere svar. Prøv igjen.', 'error');

          // Re-enable buttons on error
          rsvpButtons.forEach(btn => {
            const buttonElement = btn as HTMLButtonElement;
            buttonElement.disabled = false;
            buttonElement.removeAttribute('aria-busy');
            if (buttonElement.dataset.originalText) {
              buttonElement.textContent = buttonElement.dataset.originalText;
            }
          });
        }
      });
    });
  });
</script>
