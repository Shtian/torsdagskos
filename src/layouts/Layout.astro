---
import '../styles/global.css';
import { clerkClient } from '@clerk/astro/server';
import HeaderMobileSheet from '@/components/HeaderMobileSheet';

interface Props {
  title?: string;
  description?: string;
}

const {
  title = 'Torsdagskos',
  description = 'Torsdagskos er en privat møteplanlegger for å koordinere gjentakende arrangementer med venner.',
} = Astro.props;

// Get authenticated user
const { userId } = Astro.locals.auth();
let user: Awaited<ReturnType<ReturnType<typeof clerkClient>['users']['getUser']>> | null = null;
const shouldRegisterServiceWorker = !!userId;
const currentPath = Astro.url.pathname;
let username = 'Bruker';

const navLinks = [
  {
    href: '/history',
    label: 'Min historikk',
    icon: 'clock',
  },
  {
    href: '/settings',
    label: 'Innstillinger',
    icon: 'settings',
  },
] satisfies Array<{
  href: string;
  label: string;
  icon: 'clock' | 'settings';
}>;

if (userId) {
  user = await clerkClient(Astro).users.getUser(userId);
  username =
    user.firstName?.trim() ||
    user.username?.trim() ||
    user.emailAddresses[0]?.emailAddress.split('@')[0] ||
    'Bruker';
}
const userInitial = username.charAt(0).toUpperCase();
---

<!doctype html>
<html lang="no">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<link rel="preconnect" href="https://fonts.googleapis.com" />
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
		<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lora:wght@600;700&family=Manrope:wght@400;500;600;700&display=swap" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="generator" content={Astro.generator} />
		<meta name="description" content={description} />
		<title>{title}</title>
	</head>
	<body>
		<a
			href="#main-content"
			class="absolute left-4 -top-40 z-1000 rounded-md bg-(--color-accent-dark) px-3 py-2 text-white no-underline focus-visible:top-4"
		>
			Hopp til hovedinnhold
		</a>
		<div class="flex min-h-screen flex-col">
			<header class="sticky top-0 z-50 w-full bg-background/95 supports-backdrop-filter:bg-background/80 backdrop-blur-sm">
				<div class="mx-auto flex h-14 w-full max-w-6xl items-center px-4 sm:px-6 lg:px-8">
					<a href="/" class="mr-8 shrink-0 no-underline">
						<h1 class="m-0 text-lg font-bold tracking-tight text-foreground">Torsdagskos</h1>
					</a>

					{
						user && (
							<nav class="hidden items-center gap-1.5 md:flex" aria-label="Hovednavigasjon">
								{
									navLinks.map((link) => (
										<a
											href={link.href}
											aria-current={currentPath === link.href ? 'page' : undefined}
											class:list={[
												'min-h-11 min-w-11 inline-flex items-center gap-2 rounded-full px-3 py-2 text-sm text-muted-foreground no-underline transition hover:bg-transparent hover:text-foreground',
												currentPath === link.href ? 'font-semibold text-foreground' : 'font-medium',
											]}
										>
											{
												link.icon === 'clock' && (
													<svg class="h-4 w-4 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
														<circle cx="12" cy="12" r="9"></circle>
														<path d="M12 7v5l3 3"></path>
													</svg>
												)
											}
											{
												link.icon === 'settings' && (
													<svg class="h-4 w-4 shrink-0" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
														<circle cx="12" cy="12" r="3"></circle>
														<path d="M19.4 15a1.7 1.7 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06A1.7 1.7 0 0 0 15 19.4a1.7 1.7 0 0 0-1 .6 1.7 1.7 0 0 0-.4 1.05V21a2 2 0 0 1-4 0v-.08a1.7 1.7 0 0 0-.4-1.05 1.7 1.7 0 0 0-1-.6 1.7 1.7 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.7 1.7 0 0 0 4.6 15a1.7 1.7 0 0 0-.6-1 1.7 1.7 0 0 0-1-.4H3a2 2 0 0 1 0-4h.08a1.7 1.7 0 0 0 1-.4 1.7 1.7 0 0 0 .6-1 1.7 1.7 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.7 1.7 0 0 0 9 4.6a1.7 1.7 0 0 0 1-.6 1.7 1.7 0 0 0 .4-1.05V3a2 2 0 0 1 4 0v.08a1.7 1.7 0 0 0 .4 1.05 1.7 1.7 0 0 0 1 .6 1.7 1.7 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.7 1.7 0 0 0 19.4 9a1.7 1.7 0 0 0 .6 1 1.7 1.7 0 0 0 1 .4H21a2 2 0 0 1 0 4h-.08a1.7 1.7 0 0 0-1 .4 1.7 1.7 0 0 0-.52.6z"></path>
													</svg>
												)
											}
											{link.label}
										</a>
									))
								}
							</nav>
						)
					}

					<div class="flex-1"></div>

					{
						user ? (
							<>
									<div class="hidden items-center gap-2.5 md:flex">
										<a
											href="/events/new"
											class="inline-flex h-9 items-center gap-1.5 rounded-full bg-primary px-4 text-sm font-medium text-white no-underline transition hover:brightness-95"
										>
										<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
											<path d="M12 5v14"></path>
											<path d="M5 12h14"></path>
										</svg>
										Opprett arrangement
									</a>

									<div class="mx-1 h-6 w-px bg-border"></div>

										<div class="relative" data-header-profile-menu>
											<button
												type="button"
												id="header-profile-trigger"
												class="inline-flex h-9 items-center gap-2 rounded-full py-1 pl-1 pr-2.5 transition-colors hover:bg-secondary"
											aria-haspopup="menu"
											aria-expanded="false"
											aria-label="Konto meny"
											aria-controls="header-profile-menu"
											data-header-profile-trigger
										>
											<span class="inline-flex h-7 w-7 shrink-0 items-center justify-center rounded-full bg-primary text-xs font-semibold text-primary-foreground">{userInitial}</span>
											<span class="max-w-32 truncate text-sm font-semibold text-foreground">{username}</span>
											<svg class="h-3.5 w-3.5 text-muted-foreground" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
												<path d="m6 9 6 6 6-6"></path>
											</svg>
										</button>
										<div
											id="header-profile-menu"
											role="menu"
											aria-labelledby="header-profile-trigger"
											data-header-profile-content
											class="absolute right-0 z-50 mt-2 flex min-w-52 flex-col rounded-xl border bg-popover p-1.5 shadow-md"
											hidden
										>
											<div class="px-2 py-1.5 text-xs text-muted-foreground">
												Logget inn som <span class="font-semibold text-foreground">{username}</span>
											</div>
											<div class="my-1 h-px bg-border"></div>
											<a
												href="/profile"
												role="menuitem"
												class="min-h-11 min-w-11 inline-flex items-center gap-2.5 rounded-lg px-2 py-2 text-sm font-medium text-popover-foreground no-underline transition hover:bg-muted"
											>
												<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
													<circle cx="12" cy="8" r="4"></circle>
													<path d="M6 20c0-3.3 2.7-6 6-6s6 2.7 6 6"></path>
												</svg>
												Profil
											</a>
											<div class="my-1 h-px bg-border"></div>
											<button
												type="button"
												role="menuitem"
												data-header-logout-button
												class="min-h-11 min-w-11 inline-flex w-full cursor-pointer items-center gap-2.5 rounded-lg px-2 py-2 text-left text-sm font-medium text-destructive transition hover:bg-destructive/10"
											>
												<svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
													<path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
													<path d="m16 17 5-5-5-5"></path>
													<path d="M21 12H9"></path>
												</svg>
												Logg ut
											</button>
										</div>
									</div>
								</div>

								<HeaderMobileSheet
									client:load
									username={username}
									userInitial={userInitial}
									currentPath={currentPath}
									navLinks={navLinks}
								/>
							</>
						) : (
							<div class="ml-auto">
								<a
									href="/sign-in"
									class="min-h-11 min-w-11 inline-flex items-center rounded-full px-3 py-2 text-sm font-semibold text-foreground no-underline transition hover:bg-secondary"
								>
									Logg inn
								</a>
							</div>
						)
					}
				</div>
				<div class="h-px bg-border"></div>
			</header>

			<main id="main-content" class="mx-auto w-full max-w-300 flex-1 p-4 sm:p-6 lg:p-8">
				<slot />
			</main>
		</div>
		{shouldRegisterServiceWorker && (
			<script>
				if ('serviceWorker' in navigator) {
					navigator.serviceWorker.register('/service-worker.js').catch(() => {
						// Best-effort registration: keep UI functional even if SW setup fails.
					});
				}
			</script>
		)}
		{user && (
			<script>
				const headerMenuRoot = document.querySelector('[data-header-profile-menu]');
				if (headerMenuRoot instanceof HTMLElement) {
					const trigger = headerMenuRoot.querySelector('[data-header-profile-trigger]');
					const menu = headerMenuRoot.querySelector('[data-header-profile-content]');
					const items = () =>
						Array.from(menu?.querySelectorAll<HTMLElement>('[role="menuitem"]') ?? []);

					if (trigger instanceof HTMLButtonElement && menu instanceof HTMLElement) {
						const closeMenu = () => {
							menu.hidden = true;
							trigger.setAttribute('aria-expanded', 'false');
						};

						const openMenu = (focusFirstItem = false) => {
							menu.hidden = false;
							trigger.setAttribute('aria-expanded', 'true');
							if (focusFirstItem) {
								items()[0]?.focus();
							}
						};

						trigger.addEventListener('click', () => {
							if (menu.hidden) {
								openMenu();
								return;
							}
							closeMenu();
						});

						trigger.addEventListener('keydown', (event) => {
							if (event.key === 'ArrowDown' || event.key === 'Enter' || event.key === ' ') {
								event.preventDefault();
								openMenu(true);
							}
						});

						document.addEventListener('pointerdown', (event) => {
							if (!headerMenuRoot.contains(event.target as Node)) {
								closeMenu();
							}
						});

						document.addEventListener('keydown', (event) => {
							if (event.key === 'Escape' && !menu.hidden) {
								event.preventDefault();
								closeMenu();
								trigger.focus();
							}
						});

						menu.addEventListener('keydown', (event) => {
							if (event.key === 'Escape') {
								event.preventDefault();
								closeMenu();
								trigger.focus();
							}
						});

						for (const item of items()) {
							item.addEventListener('click', () => {
								closeMenu();
							});
						}

						const logoutButton = menu.querySelector('[data-header-logout-button]');
						if (logoutButton instanceof HTMLButtonElement) {
							logoutButton.addEventListener('click', () => {
								const cookiePrefixes = [
									'__session',
									'__client_uat',
									'__clerk_db_jwt',
									'clerk_active_context',
								];

								const cookieNames = document.cookie
									.split(';')
									.map((cookie) => cookie.trim().split('=')[0])
									.filter((name) => name.length > 0);

								for (const name of cookieNames) {
									if (cookiePrefixes.some((prefix) => name === prefix || name.startsWith(`${prefix}_`))) {
										document.cookie = `${name}=; Max-Age=0; path=/`;
									}
								}

								window.location.assign('/sign-in');
							});
						}
					}
				}

			</script>
		)}
	</body>
</html>
