# Codebase Patterns
- When introducing foreign-keyed ownership fields tied to Clerk identity, resolve `Users` by `clerkUserId` inside API routes and create the local user row on demand with unique-constraint race protection before writing the dependent record.
- For owner-restricted writes, resolve the authenticated local user before authorization and gate on `Events.ownerId`; Clerk metadata (`role=admin` or `isAdmin=true`) is the admin bypass.
- RSVP write routes should validate `Events` existence and time-window before touching `Rsvps`, and return structured 4xx payloads (`code`/`error`/`message`/`eventId`) for deterministic client and E2E handling.
- Convert event form date/time inputs with an explicit Europe/Oslo wall-time helper before `toISOString()`; `new Date(\`\${date}T\${time}\`)` leaks browser locale and shifts stored event time.
- For React-island interaction tests, wait for explicit hydration markers (`data-hydrated="true"`) before keyboard/click assertions to avoid pre-hydration flakes.
- For form-controller island migrations, expose a stable root selector plus hydration state (for example `[data-new-event-form="true"][data-hydrated="true"]`) so Playwright can synchronize before submits/assertions.
- For create/edit form islands, centralize shared field-error state shape and feedback-panel class mapping in `src/components/event-form-controller.ts` to keep behavior parity across both routes.

## Iteration Notes
## [2026-02-14 21:28:30 CET] - US-001
- Added event ownership support by introducing `Events.ownerId` as a `Users.id` foreign key in Astro DB schema.
- Updated `/api/events/create` to ensure the authenticated Clerk user is present in local `Users`, then persist `ownerId` on new events.
- Files changed: `db/config.ts`, `src/pages/api/events/create.ts`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Astro DB schema evolution is handled directly in `db/config.ts`; there is no separate checked-in SQL migration directory in this repo.
    - For auth-backed writes, API routes should not assume local `Users` rows already exist even for signed-in users.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Clerk-authenticated routes can race on first-time local user creation; guard inserts by tolerating `UNIQUE constraint` errors and re-querying.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `src/pages/api/events/create.ts` now owns event ownership assignment and is the reference path for future edit-authorization checks.
---
## [2026-02-15 14:50:51 CET] - US-002
- Enforced owner/admin authorization in `/api/events/update` by syncing the authenticated local user, checking Clerk admin metadata, and rejecting unauthorized edits with `403`.
- Added Playwright coverage for non-owner edit rejection by creating an event with a different `ownerId` and asserting `/api/events/update` returns forbidden.
- Extended test seeding helpers to support explicit event ownership (`ownerId`) for auth-sensitive scenarios.
- Files changed: `src/pages/api/events/update.ts`, `src/pages/api/test/seed.ts`, `tests/helpers/api-helpers.ts`, `tests/event-edit.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Ownership authorization must be enforced in API routes even when UI hides edit actions.
    - Seed helpers that expose ownership fields make auth edge-case E2E tests deterministic.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Authenticated Clerk sessions can exist before local `Users` rows; sync local users before ownership checks.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `tests/event-edit.spec.ts` now contains a direct non-owner forbidden-path assertion for `/api/events/update`.
---
## [2026-02-15 15:41:31 CET] - US-003
- Implemented server-side RSVP target validation in `/api/rsvp` by checking event existence and rejecting past-event submissions before any RSVP insert/update.
- Added structured error responses for invalid RSVP targets: `EVENT_NOT_FOUND` (404) and `EVENT_CLOSED` (409), each including `eventId`.
- Added Playwright API tests covering unknown-event and past-event RSVP rejection paths for authenticated users.
- Files changed: `src/pages/api/rsvp.ts`, `tests/rsvp-api.spec.ts`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - RSVP APIs should return machine-readable 4xx payloads so both UI scripts and Playwright API assertions can reliably branch on error type.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Authenticated E2E calls to `/api/rsvp` still depend on a local `Users` row; ensure the test user is synced before asserting downstream event-state validation.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `tests/rsvp-api.spec.ts` is now the primary coverage for RSVP invalid-target behavior at the API layer.
---
## [2026-02-15 15:49:56 CET] - US-005
- Fixed create-event submit conversion to parse `date` + `time` as Europe/Oslo wall time before sending the API payload.
- Added a reusable timezone helper for Oslo conversion and replaced the fragile `new Date(\`\${date}T\${time}\`)` path.
- Added Playwright coverage that captures `/api/events/create` payload and asserts the submitted ISO datetime matches Oslo semantics.
- Files changed: `src/lib/oslo-datetime.ts`, `src/pages/events/new.astro`, `tests/event-creation.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Event create/edit flows should share an explicit timezone parser so UI submission is deterministic across browser locales.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Browser-local `Date` parsing of `YYYY-MM-DDTHH:mm` is environment-dependent and can silently shift persisted event times.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `tests/event-creation.spec.ts` now contains an API payload assertion pattern for timezone-sensitive form submissions.
---
## [2026-02-15 15:59:55 CET] - US-006
- Updated edit-event submit handling to parse `date` + `time` with the shared Europe/Oslo helper before sending `/api/events/update`.
- Added Playwright coverage that intercepts `/api/events/update` and asserts the outbound `dateTime` ISO payload uses Oslo semantics.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (126 passed).
- Files changed: `src/pages/events/[id]/edit.astro`, `tests/event-edit.spec.ts`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Timezone-sensitive regression coverage is most reliable by intercepting API requests and asserting payload timestamps directly, not rendered UI times.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - `createEvent(...)` test helper expects optional fields to be omitted rather than explicitly passed as `null` to satisfy its TypeScript shape.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `tests/event-edit.spec.ts` now includes parity timezone payload validation for the edit flow (`/api/events/update`), mirroring the create-flow test strategy.
---
## [2026-02-15 16:18:27 CET] - US-007
- Migrated the desktop header profile dropdown from inline DOM scripting in `Layout.astro` to a typed React island component with keyboard/pointer accessibility behavior.
- Added hydration-aware robustness to the new island (`data-hydrated` flag) and updated Playwright coverage for header profile menu interactions, including outside-click dismissal.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (127 passed).
- Files changed: `src/components/HeaderProfileMenu.tsx`, `src/layouts/Layout.astro`, `tests/auth-header-menu.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Desktop header account-menu behavior now lives in `src/components/HeaderProfileMenu.tsx`; layout should mount this island instead of adding inline event listeners.
    - Hydration markers (`data-hydrated`) are useful for stable Playwright interactions with keyboard-first menu tests.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Keyboard-open assertions can race island hydration unless tests wait for a hydration-ready selector before pressing Enter/Space.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `tests/auth-header-menu.spec.ts` now centralizes profile-menu opening in a hydration-aware helper and covers outside-click close behavior.
---
## [2026-02-15 18:42:13 CET] - US-008
- Migrated the new-event form controller from inline `DOMContentLoaded` script to a typed React island (`NewEventForm`) mounted with `client:load`.
- Preserved existing validation, inline feedback states, and submit behavior (including Europe/Oslo conversion and redirect-on-success) while removing imperative DOM querying/listeners from `src/pages/events/new.astro`.
- Added hydration-aware Playwright coverage for the new island root before form assertions.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (127 passed).
- Files changed: `src/components/NewEventForm.tsx`, `src/pages/events/new.astro`, `tests/event-creation.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Form controller migrations are more stable when the island root exposes both a semantic marker (`data-new-event-form`) and `data-hydrated` for synchronization.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - In React islands, form `novalidate` must be expressed as `noValidate`; the lowercase HTML form fails TS checks in `.tsx`.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `src/components/NewEventForm.tsx` is now the single source of truth for create-event client validation/feedback/submission behavior.
---
## [2026-02-15 18:57:24 CET] - US-009
- Migrated edit-event form interactions from inline `DOMContentLoaded` script to a typed React island (`EditEventForm`) mounted with `client:load` in `src/pages/events/[id]/edit.astro`.
- Reused shared form-controller logic between new/edit flows by extracting common field-error initialization and feedback-panel class mapping into `src/components/event-form-controller.ts`.
- Added hydration-aware Playwright synchronization for the edit form island (`[data-edit-event-form="true"][data-hydrated="true"]`) and updated test guidance.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (127 passed).
- Files changed: `src/components/EditEventForm.tsx`, `src/components/NewEventForm.tsx`, `src/components/event-form-controller.ts`, `src/pages/events/[id]/edit.astro`, `tests/event-edit.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Create/edit form controllers should share utility state helpers so validation feedback behavior stays identical across routes.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - String-wide replacements in specs can accidentally touch helper implementations; verify helper bodies after bulk edits.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `src/components/EditEventForm.tsx` is now the single source of truth for edit-event client validation/feedback/submission behavior.
---
