# Codebase Patterns

## Database (Astro DB)
- Use `defineTable`, `column` from 'astro:db' for schema definitions
- Foreign keys: `column.number({ references: () => TableName.columns.id })`
- Optional fields: `{ optional: true }` parameter
- Composite unique indexes prevent duplicate entries (e.g., userEventIdx for one RSVP per user/event)
- Running `pnpm astro check` generates types in `.astro/integrations/astro_db/db.d.ts`

## TypeScript
- Strict mode enabled - always ensure typecheck passes with `pnpm astro check`

## Styling & Design System
- CSS custom properties defined in `src/styles/global.css` for design tokens
- Mobile-first approach: Base styles for mobile, use `@media (min-width: ...)` for larger screens
- Breakpoints: 640px (tablet), 1024px (desktop)
- Clerk components: Style the child button element, not the Clerk wrapper component

## Authentication (Clerk)
- Auth context available via `Astro.locals.auth()` in pages
- User data fetched with `clerkClient(Astro).users.getUser(userId)`
- Layout component can conditionally render UI based on auth status

---

## 2026-02-09 21:22 - US-001

**Implemented: ** Database schema setup for the Torsdagskos application

**Files changed: **
- db/config.ts - Defined all five database tables with proper schema
- package.json - Added typecheck dependencies
- pnpm-lock.yaml - Updated lockfile

**Tables created: **
1. Users (id, clerkUserId, email, name, createdAt)
2. Events (id, title, description, dateTime, location, mapLink, createdAt, updatedAt)
3. Rsvps (id, userId, eventId, status, createdAt, updatedAt)
4. Invites (id, email, invitedBy, createdAt, acceptedAt)
5. NotificationLog (id, userId, eventId, type, channel, sentAt)

**Learnings for future iterations: **
- Astro DB uses `defineTable`, `column` from 'astro:db' for schema definition
- Primary keys use `column.number({ primaryKey: true })`
- Foreign keys use `references: () => TableName.columns.id`
- Optional fields use `{ optional: true }`
- Indexes are defined in the `indexes` object within table definition
- Unique indexes use `{ unique: true }` in the index config
- Running `pnpm astro check` generates types in `.astro/integrations/astro_db/db.d.ts`
- Composite unique indexes like userEventIdx prevent duplicate RSVPs per user/event
- Date columns use `column.date()` with optional `default: new Date()`
- The `astro db verify` command requires a remote database URL, but local dev works without it

---
## 2026-02-09 21:58 - US-002

**Implemented:** Clerk authentication integration for the Torsdagskos application

**Files changed:**
- astro.config.mjs - Added Clerk integration, Node adapter, and enabled SSR
- src/middleware.ts - Created middleware to protect all routes except auth pages
- src/pages/sign-in.astro - Created sign-in page with Clerk SignIn component
- src/pages/sign-up.astro - Created sign-up page with Clerk SignUp component
- src/pages/index.astro - Added user sync logic on first load
- src/pages/api/sync-user.ts - Created API endpoint for user sync (currently unused but available)
- src/layouts/Layout.astro - Added title prop support
- db/config.ts - Fixed duplicate index names (emailIdx → inviteEmailIdx, userIdIdx → notificationUserIdIdx, eventIdIdx → notificationEventIdIdx)
- .env.example - Created template for Clerk environment variables
- CLERK_SETUP.md - Created documentation for Clerk setup
- package.json - Added @clerk/astro and @astrojs/node dependencies

**Verification:**
- Homepage (/) redirects to Clerk sign-in (307 redirect to accounts.dev/sign-in)
- Sign-in page (/sign-in) accessible and returns 200 OK
- Sign-up page (/sign-up) accessible and returns 200 OK
- Typecheck passes with 0 errors

**Learnings for future iterations:**
- Clerk for Astro uses `@clerk/astro` package with SSR required (output: 'server')
- Middleware uses `clerkMiddleware` from `@clerk/astro/server` with `createRouteMatcher` for public routes
- To get user data: use `clerkClient(context).users.getUser(userId)` - the auth object only provides userId
- Clerk components must be imported with aliases to avoid naming conflicts: `import { SignIn as ClerkSignIn } from '@clerk/astro/components'`
- All routes are protected by default; use `createRouteMatcher` to define public routes
- Auth object available via `Astro.locals.auth()` in pages and `context.locals.auth()` in API routes
- Database index names must be unique across all tables (not just within a table)
- User sync pattern: Check if user exists in local DB by clerkUserId, insert if not found
- Clerk requires PUBLIC_CLERK_PUBLISHABLE_KEY and CLERK_SECRET_KEY environment variables
- Clerk automatically handles redirect flow: unauthenticated users → Clerk hosted pages → back to app after auth
- Clerk uses its own hosted UI by default (routing="path" sends users to accounts.dev subdomain)

---

## 2026-02-09 22:10 - US-003

**Implemented:** Design system tokens and base layout with responsive header

**Files changed:**
- src/styles/global.css - Added comprehensive design system tokens (colors, typography, spacing, border radius, shadows)
- src/layouts/Layout.astro - Added sticky header with app name, user profile, sign-out button, and responsive layout structure

**Design system features:**
- Color palette: Beige/sand primary (#faf9f7 to #b3a186), accent color #6B705C
- Typography: Serif for headings (Georgia), sans-serif for body (system fonts)
- Spacing scale: 4px base (--space-1 to --space-16)
- Border radius: sm to full (--radius-sm to --radius-full)
- Responsive breakpoints: 640px (tablet), 1024px (desktop)
- Mobile-first approach with progressive enhancement

**Header features:**
- Sticky positioning with shadow
- App name as clickable link to homepage
- User profile section with name (hidden on mobile) and sign-out button
- Responsive padding and font sizes
- Only shows user profile when authenticated

**Learnings for future iterations:**
- CSS custom properties enable consistent design tokens across the app
- Clerk's SignOutButton component wraps a button element - style the button, not the wrapper
- Layout component receives auth context via Astro.locals.auth() - can conditionally show UI
- Mobile-first CSS: Base styles for mobile, then @media (min-width:...) for larger screens
- The sign-in/sign-up pages also use the Layout, so header appears there (without user profile)
- User name display: Use user.firstName as fallback before email for better UX
- Sticky header: Use position: sticky with top: 0 and z-index: 100 for persistent header
- HTML inspection via curl can verify layout when browser automation isn't available

---
## 2026-02-09 22:17 - US-004

**Implemented:** Events list page (homepage) with upcoming and past events sections

**Files changed:**
- src/pages/index.astro - Replaced placeholder content with events list functionality
- db/seed.ts - Added sample events for testing (upcoming and past events)

**Features:**
- Fetches all events from database with RSVP count aggregation
- Separates events into upcoming (future) and past sections
- Upcoming events sorted by date ascending (soonest first)
- Past events sorted by date descending (most recent first)
- Event cards show: title, formatted date/time, location, RSVP counts (going/maybe/not going)
- Links to individual event detail pages (/events/[id])
- Empty state message when no events exist
- Date/time formatting in Europe/Oslo timezone using Intl.DateTimeFormat
- Responsive grid layout: 1 column (mobile), 2 columns (tablet 640px+), 3 columns (desktop 1024px+)
- Hover effects and visual polish using design system tokens
- Past events displayed with reduced opacity for visual distinction

**Learnings for future iterations:**
- Date comparison for upcoming/past: Use `new Date(event.dateTime) >= now` to filter
- Intl.DateTimeFormat with timeZone: 'Europe/Oslo' ensures correct timezone formatting
- RSVP aggregation pattern: Fetch rsvps per event, then filter by status to count
- Grid layout: Use CSS Grid with responsive breakpoints for mobile-first design
- Event cards as links: Use `<a>` with `display: block` for entire card clickability
- Hover state: `transform: translateY(-2px)` creates subtle lift effect on hover
- Empty state: Use dashed border to distinguish from regular content containers
- TypeScript: Date objects from Astro DB can be passed directly to `new Date()`
- Database seed data: Helpful to create sample data for testing UI without manual entry
- Browser verification: Clerk authentication redirects work correctly (307 to sign-in page)
- Clerk test mode: Use test email test+clerk_test@example.com  and read the password from TEST_PASSWORD in .env in this folder. Verification code 424242 if needed.

---
