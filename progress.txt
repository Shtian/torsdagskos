# Codebase Patterns
- When introducing foreign-keyed ownership fields tied to Clerk identity, resolve `Users` by `clerkUserId` inside API routes and create the local user row on demand with unique-constraint race protection before writing the dependent record.
- For owner-restricted writes, resolve the authenticated local user before authorization and gate on `Events.ownerId`; Clerk metadata (`role=admin` or `isAdmin=true`) is the admin bypass.
- RSVP write routes should validate `Events` existence and time-window before touching `Rsvps`, and return structured 4xx payloads (`code`/`error`/`message`/`eventId`) for deterministic client and E2E handling.
- Convert event form date/time inputs with an explicit Europe/Oslo wall-time helper before `toISOString()`; `new Date(\`\${date}T\${time}\`)` leaks browser locale and shifts stored event time.
- For React-island interaction tests, wait for explicit hydration markers (`data-hydrated="true"`) before keyboard/click assertions to avoid pre-hydration flakes.
- Keep `ShadcnIslandDemo` on `/demo/shadcn-island` (not `/`) and point island interaction tests to the demo route so homepage remains product-focused.
- For settings notification island migrations, keep `#permission-status`, `#saved-preference`, `#request-permission`, and `#feedback` selectors stable and expose `[data-settings-notifications="true"][data-hydrated="true"]` for hydration-safe Playwright interactions.
- For form-controller island migrations, expose a stable root selector plus hydration state (for example `[data-new-event-form="true"][data-hydrated="true"]`) so Playwright can synchronize before submits/assertions.
- For create/edit form islands, centralize shared field-error state shape and feedback-panel class mapping in `src/components/event-form-controller.ts` to keep behavior parity across both routes.
- For event-detail RSVP island flows, keep RSVP button data attributes (`data-rsvp-button`, `data-status`, `data-active`) stable and wait for `[data-event-rsvp="true"][data-hydrated="true"]` in Playwright before interaction assertions.
- Keep homepage `EventCard` rendering server-only (no `client:*` hydration); in Playwright, verify cards are not wrapped by `astro-island` to guard performance regressions.
- On homepage event listings, aggregate RSVP counts in one `groupBy(eventId, status)` query and map results per event; avoid per-event RSVP lookups in render paths.
- On event detail pages, fetch RSVP + user display data with a single `leftJoin(Rsvps, Users)` query (or equivalent batched query) to avoid per-RSVP user lookups while preserving grouped RSVP rendering.
- On history pages, load RSVP cards via one joined `Rsvps` + `Events` query scoped by `Rsvps.userId`, then filter null joined events before sorting/rendering.
- For notification deduplication, prefetch `NotificationLog` user IDs once per `(eventId, type, channel)` before fan-out loops; avoid issuing log existence queries inside per-user send iterations.
- Use `ensureLocalUser(contextOrAstro, userId)` from `src/lib/local-user-sync.ts` for create-on-read local user sync in both API routes and `.astro` pages; do not duplicate inline Clerk-to-Users insert/retry blocks.

## Iteration Notes
## [2026-02-14 21:28:30 CET] - US-001
- Added event ownership support by introducing `Events.ownerId` as a `Users.id` foreign key in Astro DB schema.
- Updated `/api/events/create` to ensure the authenticated Clerk user is present in local `Users`, then persist `ownerId` on new events.
- Files changed: `db/config.ts`, `src/pages/api/events/create.ts`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Astro DB schema evolution is handled directly in `db/config.ts`; there is no separate checked-in SQL migration directory in this repo.
    - For auth-backed writes, API routes should not assume local `Users` rows already exist even for signed-in users.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Clerk-authenticated routes can race on first-time local user creation; guard inserts by tolerating `UNIQUE constraint` errors and re-querying.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `src/pages/api/events/create.ts` now owns event ownership assignment and is the reference path for future edit-authorization checks.
---
## [2026-02-15 14:50:51 CET] - US-002
- Enforced owner/admin authorization in `/api/events/update` by syncing the authenticated local user, checking Clerk admin metadata, and rejecting unauthorized edits with `403`.
- Added Playwright coverage for non-owner edit rejection by creating an event with a different `ownerId` and asserting `/api/events/update` returns forbidden.
- Extended test seeding helpers to support explicit event ownership (`ownerId`) for auth-sensitive scenarios.
- Files changed: `src/pages/api/events/update.ts`, `src/pages/api/test/seed.ts`, `tests/helpers/api-helpers.ts`, `tests/event-edit.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Ownership authorization must be enforced in API routes even when UI hides edit actions.
    - Seed helpers that expose ownership fields make auth edge-case E2E tests deterministic.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Authenticated Clerk sessions can exist before local `Users` rows; sync local users before ownership checks.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `tests/event-edit.spec.ts` now contains a direct non-owner forbidden-path assertion for `/api/events/update`.
---
## [2026-02-15 15:41:31 CET] - US-003
- Implemented server-side RSVP target validation in `/api/rsvp` by checking event existence and rejecting past-event submissions before any RSVP insert/update.
- Added structured error responses for invalid RSVP targets: `EVENT_NOT_FOUND` (404) and `EVENT_CLOSED` (409), each including `eventId`.
- Added Playwright API tests covering unknown-event and past-event RSVP rejection paths for authenticated users.
- Files changed: `src/pages/api/rsvp.ts`, `tests/rsvp-api.spec.ts`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - RSVP APIs should return machine-readable 4xx payloads so both UI scripts and Playwright API assertions can reliably branch on error type.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Authenticated E2E calls to `/api/rsvp` still depend on a local `Users` row; ensure the test user is synced before asserting downstream event-state validation.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `tests/rsvp-api.spec.ts` is now the primary coverage for RSVP invalid-target behavior at the API layer.
---
## [2026-02-15 15:49:56 CET] - US-005
- Fixed create-event submit conversion to parse `date` + `time` as Europe/Oslo wall time before sending the API payload.
- Added a reusable timezone helper for Oslo conversion and replaced the fragile `new Date(\`\${date}T\${time}\`)` path.
- Added Playwright coverage that captures `/api/events/create` payload and asserts the submitted ISO datetime matches Oslo semantics.
- Files changed: `src/lib/oslo-datetime.ts`, `src/pages/events/new.astro`, `tests/event-creation.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Event create/edit flows should share an explicit timezone parser so UI submission is deterministic across browser locales.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Browser-local `Date` parsing of `YYYY-MM-DDTHH:mm` is environment-dependent and can silently shift persisted event times.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `tests/event-creation.spec.ts` now contains an API payload assertion pattern for timezone-sensitive form submissions.
---
## [2026-02-15 15:59:55 CET] - US-006
- Updated edit-event submit handling to parse `date` + `time` with the shared Europe/Oslo helper before sending `/api/events/update`.
- Added Playwright coverage that intercepts `/api/events/update` and asserts the outbound `dateTime` ISO payload uses Oslo semantics.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (126 passed).
- Files changed: `src/pages/events/[id]/edit.astro`, `tests/event-edit.spec.ts`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Timezone-sensitive regression coverage is most reliable by intercepting API requests and asserting payload timestamps directly, not rendered UI times.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - `createEvent(...)` test helper expects optional fields to be omitted rather than explicitly passed as `null` to satisfy its TypeScript shape.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `tests/event-edit.spec.ts` now includes parity timezone payload validation for the edit flow (`/api/events/update`), mirroring the create-flow test strategy.
---
## [2026-02-15 16:18:27 CET] - US-007
- Migrated the desktop header profile dropdown from inline DOM scripting in `Layout.astro` to a typed React island component with keyboard/pointer accessibility behavior.
- Added hydration-aware robustness to the new island (`data-hydrated` flag) and updated Playwright coverage for header profile menu interactions, including outside-click dismissal.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (127 passed).
- Files changed: `src/components/HeaderProfileMenu.tsx`, `src/layouts/Layout.astro`, `tests/auth-header-menu.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Desktop header account-menu behavior now lives in `src/components/HeaderProfileMenu.tsx`; layout should mount this island instead of adding inline event listeners.
    - Hydration markers (`data-hydrated`) are useful for stable Playwright interactions with keyboard-first menu tests.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Keyboard-open assertions can race island hydration unless tests wait for a hydration-ready selector before pressing Enter/Space.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `tests/auth-header-menu.spec.ts` now centralizes profile-menu opening in a hydration-aware helper and covers outside-click close behavior.
---
## [2026-02-15 18:42:13 CET] - US-008
- Migrated the new-event form controller from inline `DOMContentLoaded` script to a typed React island (`NewEventForm`) mounted with `client:load`.
- Preserved existing validation, inline feedback states, and submit behavior (including Europe/Oslo conversion and redirect-on-success) while removing imperative DOM querying/listeners from `src/pages/events/new.astro`.
- Added hydration-aware Playwright coverage for the new island root before form assertions.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (127 passed).
- Files changed: `src/components/NewEventForm.tsx`, `src/pages/events/new.astro`, `tests/event-creation.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Form controller migrations are more stable when the island root exposes both a semantic marker (`data-new-event-form`) and `data-hydrated` for synchronization.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - In React islands, form `novalidate` must be expressed as `noValidate`; the lowercase HTML form fails TS checks in `.tsx`.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `src/components/NewEventForm.tsx` is now the single source of truth for create-event client validation/feedback/submission behavior.
---
## [2026-02-15 18:57:24 CET] - US-009
- Migrated edit-event form interactions from inline `DOMContentLoaded` script to a typed React island (`EditEventForm`) mounted with `client:load` in `src/pages/events/[id]/edit.astro`.
- Reused shared form-controller logic between new/edit flows by extracting common field-error initialization and feedback-panel class mapping into `src/components/event-form-controller.ts`.
- Added hydration-aware Playwright synchronization for the edit form island (`[data-edit-event-form="true"][data-hydrated="true"]`) and updated test guidance.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (127 passed).
- Files changed: `src/components/EditEventForm.tsx`, `src/components/NewEventForm.tsx`, `src/components/event-form-controller.ts`, `src/pages/events/[id]/edit.astro`, `tests/event-edit.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Create/edit form controllers should share utility state helpers so validation feedback behavior stays identical across routes.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - String-wide replacements in specs can accidentally touch helper implementations; verify helper bodies after bulk edits.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `src/components/EditEventForm.tsx` is now the single source of truth for edit-event client validation/feedback/submission behavior.
---
## [2026-02-15 20:34:31 CET] - US-010
- Migrated event-detail RSVP interactions from inline `DOMContentLoaded` scripting to a typed React island (`EventRsvpControls`) mounted with `client:load` in `src/pages/events/[id].astro`.
- Replaced full-page reload behavior with optimistic/local RSVP state updates for active button state and RSVP counts, while keeping inline busy/error/success feedback accessible via the existing feedback panel contract.
- Added hydration-aware RSVP coverage and no-navigation assertions in Playwright for event detail interactions.
- Files changed: `src/components/EventRsvpControls.tsx`, `src/pages/events/[id].astro`, `tests/rsvp.spec.ts`, `tests/event-detail-ui.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Event-detail RSVP interactions should be implemented via `EventRsvpControls` with `[data-event-rsvp="true"][data-hydrated="true"]` synchronization in tests before clicking RSVP buttons.
    - Prefer optimistic/local count updates over reloads for RSVP state changes; keep `data-rsvp-button` and `data-active` attributes stable to preserve existing spec selectors.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Full-suite Playwright runs can hit intermittent infra/network flakes (`ERR_NETWORK_IO_SUSPENDED`/detached frame timeouts); validate changed RSVP flows with focused spec reruns when diagnosing unrelated failures.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `src/components/EventRsvpControls.tsx` now owns detail-page RSVP client behavior, and `src/pages/events/[id].astro` only passes initial status/count props.
---
## [2026-02-15 20:50:33 CET] - US-011
- Migrated settings notification interactions from inline `@ts-nocheck` script to a typed React island (`SettingsNotifications`) mounted with `client:load` in `src/pages/settings.astro`.
- Preserved existing notification selectors and feedback contract while keeping permission checks, preference persistence, and push subscription sync behavior in typed component logic.
- Added hydration-aware Playwright synchronization for settings notification interactions and documented the pattern in test guidance.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (127 passed).
- Files changed: `src/components/SettingsNotifications.tsx`, `src/pages/settings.astro`, `tests/settings.spec.ts`, `tests/settings-ui.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Settings notification UI should be implemented in `src/components/SettingsNotifications.tsx` and mounted from `src/pages/settings.astro` with `client:load`.
    - Hydration markers on settings island roots (`[data-settings-notifications="true"][data-hydrated="true"]`) make notification permission/submission assertions deterministic in Playwright.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - `PushManager.subscribe` type checks can require a `BufferSource` cast for the VAPID key `Uint8Array` under current TS lib types.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `tests/settings.spec.ts` and `tests/settings-ui.spec.ts` now wait for settings-island hydration before click/feedback assertions.
---
## [2026-02-15 21:32:24 CET] - US-012
- Removed unnecessary homepage hydration for `EventCard` by dropping `client:load` from upcoming and past event lists in `src/pages/index.astro`.
- Added Playwright coverage to assert populated homepage cards remain rendered and are not nested inside `astro-island`, protecting against accidental re-hydration.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (127 passed).
- Files changed: `src/pages/index.astro`, `tests/homepage-ui.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Static homepage event cards should remain server-rendered to avoid unnecessary client bundle and hydration overhead.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - React components in Astro hydrate only when `client:*` is present; accidental directive reintroduction can silently regress performance.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `tests/homepage-ui.spec.ts` now contains a regression assertion (`astro-island [data-test-id="event-card"]` count `0`) for hydration-free event cards.
---
## [2026-02-15 21:37:20 CET] - US-013
- Replaced homepage RSVP count N+1 queries with a single grouped aggregation query (`groupBy` on `eventId` + `status`) and a per-event count map.
- Preserved `EventCard` RSVP count output contract (`going`, `maybe`, `notGoing`) while removing per-event database round trips.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (127 passed).
- Files changed: `src/pages/index.astro`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Astro DB supports efficient grouped count aggregation for RSVP summaries, which should be preferred over per-entity fetch loops in list routes.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - RSVP status values are stored as `going`/`maybe`/`not_going`; homepage view-model mapping still needs `notGoing` key for `EventCard` props.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `src/pages/index.astro` now centralizes homepage RSVP aggregation logic before upcoming/past event partitioning.
---
## [2026-02-15 22:17:05 CET] - US-014
- Reworked event-detail RSVP user loading in `src/pages/events/[id].astro` to use a joined RSVP+user query (`leftJoin`) instead of manual per-RSVP user mapping patterns.
- Added Playwright regression coverage to ensure RSVP group headings/counts and grouped user lists remain correct after the data-fetch refactor.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (128 passed).
- Files changed: `src/pages/events/[id].astro`, `tests/event-detail-ui.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Event detail RSVP lists should source display data from a joined RSVP+Users fetch so group rendering remains correct without query fan-out.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Playwright strict mode can collide on substring name matches (for example `Going User` within `Not Going User`); use `getByText(value, { exact: true })` for person-name assertions.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `tests/event-detail-ui.spec.ts` now includes a dedicated RSVP grouping regression (`renders RSVP groups with correct users and counts`) tied to the event-detail data-loading path.
---
## [2026-02-15 22:28:04 CET] - US-015
- Replaced history page RSVP event loading N+1 pattern with a single joined query (`leftJoin` between `Rsvps` and `Events`) scoped to the current user.
- Preserved rendering behavior by filtering rows where joined `event` is `null`, then sorting history entries by event datetime descending before display.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (128 passed).
- Files changed: `src/pages/history.astro`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - History-route RSVP cards should be sourced from one joined RSVP+event query to avoid query fan-out and keep list rendering scalable.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - `leftJoin` keeps orphaned RSVP rows; explicitly filter out `event === null` before reading event fields to keep type safety and avoid runtime null access.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `src/pages/history.astro` now owns the canonical joined RSVP+event history loading path and downstream descending date sort.
---
## [2026-02-16 08:42:53 CET] - US-016
- Refactored notification deduplication to preload `NotificationLog` state before send fan-out loops for both push and reminder-email delivery paths.
- Removed per-user log-existence queries inside notification loops by using precomputed user-id sets keyed by event/type/channel.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (128 passed).
- Files changed: `src/lib/event-notifications.ts`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Notification send paths should query dedup log state once per event/type/channel and perform in-memory membership checks during user fan-out.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Keep dedup prefetch outside `users.map(...)`; moving it inside silently reintroduces N+1 queries even if logic remains functionally correct.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `src/lib/event-notifications.ts` now owns batched dedup logic for both `sendPushNotificationsToOptedInUsers` and `sendEventReminderNotifications`.
---
## [2026-02-16 08:49:24 CET] - US-017
- Removed `ShadcnIslandDemo` from the production homepage and kept homepage event sections/duplicate action behavior unchanged.
- Added a dedicated demo route at `/demo/shadcn-island` to host the existing React island.
- Updated Playwright specs for shadcn island interactions to use the dedicated demo route and added a homepage regression assertion that the demo island is absent.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (128 passed).
- Files changed: `src/pages/index.astro`, `src/pages/demo/shadcn-island.astro`, `tests/shadcn-island.spec.ts`, `tests/overlay-primitives.spec.ts`, `tests/surface-primitives.spec.ts`, `tests/homepage-ui.spec.ts`, `tests/AGENTS.md`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Keep dev/demo component showcases on dedicated `/demo/*` routes so production pages stay focused and avoid extra client hydration in core flows.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Moving a hydrated island off a primary page requires updating all helper navigations in related Playwright specs, not just one test file.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `src/pages/demo/shadcn-island.astro` is now the canonical route for shadcn primitive and island-interaction tests.
---
## [2026-02-16 08:58:55 CET] - US-018
- Centralized local user create-on-read behavior into a shared helper (`ensureLocalUser` / `getLocalUserByClerkId`) in `src/lib/local-user-sync.ts`.
- Replaced duplicated Clerk-to-`Users` sync blocks across event APIs, settings APIs, sync-user API, and page routes (`index`, `history`, `settings`) with the shared helper while preserving race-safe unique-constraint handling.
- Ran required quality checks: `pnpm astro check` and `pnpm test` (128 passed).
- Files changed: `src/lib/local-user-sync.ts`, `src/pages/api/events/create.ts`, `src/pages/api/events/update.ts`, `src/pages/api/settings/notifications.ts`, `src/pages/api/settings/push-subscription.ts`, `src/pages/api/sync-user.ts`, `src/pages/index.astro`, `src/pages/history.astro`, `src/pages/settings.astro`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Local user sync is now a shared service concern in `src/lib/local-user-sync.ts`; feature code should call the helper instead of re-implementing sync logic.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Settings APIs should call `ensureLocalUser(...)` first, then perform explicit `update(Users)` writes for notification/subscription fields so behavior is consistent for both first-time and existing users.
  - Useful context (e.g., "the evaluation panel is in component X")
    - Event create/update ownership paths now rely on the same local-user sync helper, making auth and ownership behavior consistent across route types.
---
