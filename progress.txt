# Codebase Patterns
- When introducing foreign-keyed ownership fields tied to Clerk identity, resolve `Users` by `clerkUserId` inside API routes and create the local user row on demand with unique-constraint race protection before writing the dependent record.

## Iteration Notes
## [2026-02-14 21:28:30 CET] - US-001
- Added event ownership support by introducing `Events.ownerId` as a `Users.id` foreign key in Astro DB schema.
- Updated `/api/events/create` to ensure the authenticated Clerk user is present in local `Users`, then persist `ownerId` on new events.
- Files changed: `db/config.ts`, `src/pages/api/events/create.ts`, `prd.json`, `progress.txt`
- **Learnings for future iterations**
  - Patterns discovered (e.g., "this codebase uses X for Y")
    - Astro DB schema evolution is handled directly in `db/config.ts`; there is no separate checked-in SQL migration directory in this repo.
    - For auth-backed writes, API routes should not assume local `Users` rows already exist even for signed-in users.
  - Gotchas encountered (e.g., "don't forget to update Z when changing W")
    - Clerk-authenticated routes can race on first-time local user creation; guard inserts by tolerating `UNIQUE constraint` errors and re-querying.
  - Useful context (e.g., "the evaluation panel is in component X")
    - `src/pages/api/events/create.ts` now owns event ownership assignment and is the reference path for future edit-authorization checks.
---
